var vortexVShader="attribute vec3 vert;\nattribute vec3 normal;\nattribute vec2 texcoord;\nuniform mat4 u_mvMatrix;\nuniform mat4 u_invMvMatrix;\nuniform vec3 u_eye;\nuniform mat4 u_normalMatrix;\nuniform mat4 u_projMatrix;\nvarying vec3 vNormal;\nvarying vec3 vCPos;\nvarying vec3 vECPos;\nvarying vec2 vTexcoord;\nvarying vec3 vEyePos;\nvarying vec3 vSrcNormal;\nvoid main()\n{\n\tvTexcoord       = texcoord;\n\tvCPos           = vert;\n   vEyePos         = u_eye;\n\tvECPos\t    = (u_mvMatrix*vec4(vert, 1.0)).xyz;\n\tvNormal \t= (u_normalMatrix*vec4(normal, 1.0)).xyz;\n   vSrcNormal  = normal;\n\tgl_Position\t= u_projMatrix * vec4(vECPos, 1.0);\n}";var vortexFShader="#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D layerMap1;\nuniform sampler2D layerMap2;\nuniform sampler2D colorMeMap1;\nuniform sampler2D colorMeMap2;\nuniform sampler2D normalMap1;\nuniform sampler2D normalMap2;\nuniform sampler2D envDiff;\nuniform sampler2D envMap;\nuniform mat4 u_invMvMatrix;\nuniform sampler2D stickerMap0;\nuniform sampler2D stickerMap1;\nuniform sampler2D stickerMap2;\nuniform sampler2D stickerMap3;\nuniform sampler2D stickerMap4;\nuniform sampler2D stickerMap5;\nuniform sampler2D stickerMap6;\nuniform sampler2D stickerMap7;\nuniform mat4 u_stickerMatrix0;\nuniform mat4 u_stickerMatrix1;\nuniform mat4 u_stickerMatrix2;\nuniform mat4 u_stickerMatrix3;\nuniform mat4 u_stickerMatrix4;\nuniform mat4 u_stickerMatrix5;\nuniform mat4 u_stickerMatrix6;\nuniform mat4 u_stickerMatrix7;\nuniform vec3 u_stickerPos0;\nuniform vec3 u_stickerPos1;\nuniform vec3 u_stickerPos2;\nuniform vec3 u_stickerPos3;\nuniform vec3 u_stickerPos4;\nuniform vec3 u_stickerPos5;\nuniform vec3 u_stickerPos6;\nuniform vec3 u_stickerPos7;\nuniform vec4 \tu_ambient;\nuniform vec4 \tu_diffuse;\nuniform vec4 \tu_specular;\nuniform vec4 \tu_fillColor1;\nuniform vec4 \tu_fillColor2;\nuniform vec4 \tu_skinColor;\nuniform float \tu_shininess;\nvarying vec3 vNormal;\nvarying vec3 vCPos;\nvarying vec3 vECPos;\nvarying vec2 vTexcoord;\nvarying vec3 vEyePos;\nvarying vec3 vSrcNormal;\nvec3 srcNormal;\nvec4 TextureProject(mat4 texMat, vec3 texPos, sampler2D sampleMap, vec4 texelColor)\n{\n   float facing     = dot(normalize(texPos - vCPos), srcNormal);\n   if (facing>0.0)\n   {\n       mat4 eye          = texMat * u_invMvMatrix;\n       vec4 eyeVertex    = vec4(vECPos, 1.0);\n       vec4 texel        = eye * eyeVertex;\n       vec4 stickerTexel = vec4(texture2D(sampleMap, texel.xy));\n       texelColor.rgb    = (stickerTexel.rgb * stickerTexel.a) + (texelColor.rgb*(1.0-stickerTexel.a));\n   }\n   return texelColor;\n}\nvoid main()\n{\n\tvec3 normal         = normalize(vNormal);\n   srcNormal           = normalize(vSrcNormal);\n   vec3 mapNormal = normalize(2.0*(texture2D(normalMap1, vTexcoord).xyz + texture2D(normalMap2, vTexcoord).xyz) - 2.0);\n   mapNormal = mapNormal.x*(cross(vec3(0.0, 1.0, 0.0), normal)) + mapNormal.y*vec3(0.0, 1.0, 0.0) + mapNormal.z*normal;\n   vec2 vEnvMapTexcoord = vec2(0.0, 0.0);\n   vec3 toCam = vec3(vECPos.xyz - vEyePos.xyz);\n   vec3 r = reflect( normalize(toCam), mapNormal);\n   float m = 2.0 * sqrt( r.x*r.x + r.y*r.y + (r.z+1.0)*(r.z+1.0) );\n\tvEnvMapTexcoord.x = r.x/m + 0.5;\n\tvEnvMapTexcoord.y = r.y/m + 0.5;\n   vec4 specTexel1 = texture2D(colorMeMap1, vTexcoord);\n   vec4 specTexel2 = texture2D(colorMeMap2, vTexcoord);\n   vec4 faceTexel = texture2D(layerMap1, vTexcoord);\n   vec4 hairTexel = texture2D(layerMap2, vTexcoord);\n   vec4 envMapTexel1    = vec4(texture2D(envMap, vEnvMapTexcoord).rgb*specTexel1.r + texture2D(envDiff, vEnvMapTexcoord).rgb*(1.0 - specTexel1.r), 0.0)*u_skinColor;\n   vec4 envMapTexel2    = (vec4(texture2D(envMap, vEnvMapTexcoord).rgb*specTexel2.r + texture2D(envDiff, vEnvMapTexcoord).rgb*(1.0 - specTexel2.r), 0.0))*0.2*u_skinColor;\n   vec4 colorMod1       = vec4(1.0, 1.0, 1.0, 1.0) - vec4(1.0 - u_fillColor1.r, 1.0 - u_fillColor1.g, 1.0 - u_fillColor1.b, 1.0 - u_fillColor1.a)*specTexel1.g;\n   vec4 colorMod2       = vec4(1.0, 1.0, 1.0, 1.0) - vec4(1.0 - u_fillColor2.r, 1.0 - u_fillColor2.g, 1.0 - u_fillColor2.b, 1.0 - u_fillColor2.a)*specTexel2.g;\n   faceTexel.rgb    = colorMod1.rgb*faceTexel.rgb*faceTexel.a + envMapTexel1.rgb*(1.0 - faceTexel.a);\n   hairTexel.rgb    = colorMod2.rgb*hairTexel.rgb*hairTexel.a + envMapTexel2.rgb*specTexel2.r;\n   float fresnelFactor = pow((1.0 - dot( normalize(-toCam), normal)),4.0)*(0.9 - 0.45*hairTexel.a);\n   vec4 finalTexel     = vec4(hairTexel.rgb*hairTexel.a + faceTexel.rgb*(1.0 - hairTexel.a), 1.0);\n   finalTexel = TextureProject(u_stickerMatrix0, u_stickerPos0, stickerMap0, finalTexel);\n   finalTexel = TextureProject(u_stickerMatrix1, u_stickerPos1, stickerMap1, finalTexel);\n   finalTexel = TextureProject(u_stickerMatrix2, u_stickerPos2, stickerMap2, finalTexel);\n   finalTexel = TextureProject(u_stickerMatrix3, u_stickerPos3, stickerMap3, finalTexel);\n   finalTexel = TextureProject(u_stickerMatrix4, u_stickerPos4, stickerMap4, finalTexel);\n   finalTexel = TextureProject(u_stickerMatrix5, u_stickerPos5, stickerMap5, finalTexel);\n   finalTexel = TextureProject(u_stickerMatrix6, u_stickerPos6, stickerMap6, finalTexel);\n   finalTexel = TextureProject(u_stickerMatrix7, u_stickerPos7, stickerMap7, finalTexel);\n\tgl_FragColor = vec4(finalTexel.rgb + vec3(fresnelFactor, fresnelFactor, fresnelFactor), 1.0);\n}";var linesVShader="attribute vec3 point;\nuniform mat4 u_worldMatrix;\nuniform mat4 u_viewMatrix;\nuniform mat4 u_projMatrix;\nvoid main()\n{\n\tvec3 pos = point;\n\tmat4 mvp = u_projMatrix*u_viewMatrix*u_worldMatrix;\n\tgl_Position\t= mvp * vec4(pos, 1.0);\n}";var linesFShader="#ifdef GL_ES\nprecision highp float;\n#endif\nuniform vec4 u_lineColor;\nvoid main()\n{\n\tgl_FragColor = u_lineColor;\n}";var screenQuad_vShader="attribute vec3 vert;\nattribute vec2 texcoord;\nuniform float u_inv_viewport_width;\nuniform float u_inv_viewport_height;\nvarying vec2 vTexcoord;\nvoid main()\n{\ngl_Position = vec4(vert.xy, 0.0, 1.0);\nvTexcoord.x = 0.5 * (1.0 + vert.x + u_inv_viewport_width);\nvTexcoord.y = 0.5 * (1.0 - vert.y + u_inv_viewport_height);\n}";var screenQuad_fShader="#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D basemap;\nvarying vec2 vTexcoord;\nvoid main()\n{\n\tvec2 tex = vec2(vTexcoord.x, 1.0 - vTexcoord.y);\n\tvec4 texel = texture2D(basemap, tex );\n\tgl_FragColor = texel;\n}";var depthMapVShader="attribute vec3 vert;\nattribute vec3 normal;\nattribute vec2 texcoord;\nuniform mat4 u_mvpLightMatrix;\nvarying vec4 vPos;\nvoid main()\n{\n\tvec4 pos\t= u_mvpLightMatrix * vec4(vert, 1.0);\n   vPos = pos;\n\tgl_Position\t= pos;\n}";var depthMapFShader="#ifdef GL_ES\nprecision highp float;\n#endif\nvarying vec4 vPos;\nvoid main()\n{\nfloat shadow = 0.5;\n\tgl_FragColor = vec4(shadow,shadow,shadow, 1.0);\n}";var shadow_vshader="attribute vec3 vert;\nattribute vec3 normal;\nattribute vec2 texcoord;\nuniform mat4 u_mvMatrix;\nuniform mat4 u_projMatrix;\nuniform mat4 u_shadowLightWorld;\nuniform mat4 u_shadowBiasMatrix;\nuniform mat4 u_vShadowLight;\nvarying vec4 vShadowCoord;\nvoid main()\n{\n\tvec4 pos\t    = (u_mvMatrix*vec4(vert, 1.0));\n\tgl_Position\t= u_projMatrix * pos;\n\tmat4 shadowMat  = u_shadowBiasMatrix*u_projMatrix*u_vShadowLight;\n   vShadowCoord    = shadowMat * vec4(vert, 1.0);\n}";var shadow_fshader="#define BLOCKER_SEARCH_NUM_SAMPLES 16\n#define PCF_NUM_SAMPLES 16\n#define NEAR_PLANE 4.5 \n#define LIGHT_WORLD_SIZE 3.0 \n#define LIGHT_FRUSTUM_WIDTH 8.0 \n#define LIGHT_SIZE_UV (LIGHT_WORLD_SIZE / LIGHT_FRUSTUM_WIDTH) \n#define SHADOW_EPSILON 0.1\n#define SMAP_SIZE 1024.0\n#define texMapScale 1.0/SMAP_SIZE\n#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D shadowMap;\nvec2 poissonDisk[16];\nvarying vec4 vShadowCoord;\nfloat unpackTex2D(sampler2D map, vec2 coord);\nfloat PCSS(vec4 coords);\nvoid FindBlocker(out float avgBlockerDepth, out float numBlockers, vec2 uv, float zReceiver );\nfloat PenumbraSize(float zReceiver, float zBlocker); //Parallel plane estimation \nfloat PCF_Filter(vec2 uv, float zReceiver, float filterRadiusUV);\nvoid main()\n{\n\tvec4 shadowCoord    = vec4(vShadowCoord.xyz / vShadowCoord.w, vShadowCoord.w);\n\tvec4 rgba_depth = texture2D(shadowMap, shadowCoord.xy);\n\tgl_FragColor = vec4(0.0,0.0,0.0, rgba_depth.r);\n}\nfloat unpackTex2D(sampler2D map, vec2 coord)\n{\n\tvec4 rgba_depth = texture2D(map, coord.xy);\n\tconst vec4 bit_shift = vec4(1.0/(256.0*256.0*256.0), 1.0/(256.0*256.0), 1.0/256.0, 1.0);\n\treturn dot(rgba_depth, bit_shift);\n}\nfloat PenumbraSize(float zReceiver, float zBlocker) //Parallel plane estimation \n{\nreturn (zReceiver - zBlocker) / zBlocker; \n}\nvoid FindBlocker(out float avgBlockerDepth, out float numBlockers, vec2 uv, float zReceiver )\n{\nfloat searchWidth = (LIGHT_SIZE_UV*(zReceiver - NEAR_PLANE) / zReceiver)/SMAP_SIZE; \nfloat blockerSum = 0.0;\nnumBlockers = 0.0;\nfor( int i = 0; i < BLOCKER_SEARCH_NUM_SAMPLES; i++)\n{\nfloat shadowMapDepth = unpackTex2D(shadowMap, uv + poissonDisk[i]*searchWidth);\nif(shadowMapDepth + SHADOW_EPSILON < zReceiver)\n{\nblockerSum += shadowMapDepth;\nnumBlockers++;\n}\n}\navgBlockerDepth = blockerSum/numBlockers;\n}\nfloat PCF_Filter(vec2 uv, float zReceiver, float filterRadiusUV)\n{\nfloat sum = 0.0;\nfloat scale = 10.0/SMAP_SIZE;\nfloat sample= 0.0;\nfor(int i = 0; i < PCF_NUM_SAMPLES;i++)\n{\nvec2 sampleuv = uv + (poissonDisk[i]*scale);\nsample = unpackTex2D(shadowMap, sampleuv) + SHADOW_EPSILON;\nsum += sample < zReceiver ? 1.0 : 0.3;\n}\nreturn sum/float(PCF_NUM_SAMPLES);\n}\nfloat PCSS(vec4 coords)\n{\npoissonDisk[0] = vec2( -0.94201624, -0.39906216 );\npoissonDisk[1] = vec2( 0.94558609, -0.76890725 );\npoissonDisk[2] = vec2( -0.094184101, -0.92938870);\npoissonDisk[3] = vec2( 0.34495938, 0.29387760 );\npoissonDisk[4] = vec2( -0.91588581, 0.45771432 );\npoissonDisk[5] = vec2( -0.81544232, -0.87912464 );\npoissonDisk[6] = vec2( -0.38277543, 0.27676845 );\npoissonDisk[7] = vec2( 0.97484398, 0.75648379 );\npoissonDisk[8] = vec2( 0.44323325, -0.97511554 );\npoissonDisk[9] = vec2( 0.53742981, -0.47373420 );\npoissonDisk[10] = vec2( -0.26496911, -0.41893023 );\npoissonDisk[11] = vec2( 0.79197514, 0.19090188 );\npoissonDisk[12] = vec2( -0.24188840, 0.99706507 );\npoissonDisk[13] = vec2( -0.81409955, 0.91437590 );\npoissonDisk[14] = vec2( 0.19984126, 0.78641367 );\npoissonDisk[15] = vec2( 0.14383161, -0.14100790 );\nvec2 uv = coords.xy;\nfloat zReceiver = coords.z;\nfloat avgBlockerDepth = 0.0;\nfloat numBlockers = 0.0;\nFindBlocker(avgBlockerDepth, numBlockers, uv, zReceiver);\nif(numBlockers < 1.0)\n{\nreturn 0.1;\n}\nfloat penumbraRatio = PenumbraSize(zReceiver, avgBlockerDepth);\nfloat filterRadiusUV = penumbraRatio*LIGHT_SIZE_UV*NEAR_PLANE/coords.z;\nreturn PCF_Filter(uv, zReceiver, filterRadiusUV);\n}";var radialBlur_vshader="attribute vec3 vert;\nattribute vec2 texcoord;\nuniform float u_inv_viewport_width;\nuniform float u_inv_viewport_height;\nvarying vec2 vTexcoord;\nvoid main()\n{\ngl_Position = vec4(vert.xy, 0.0, 1.0);\nvTexcoord.x = 0.5 * (1.0 + vert.x + u_inv_viewport_width);\nvTexcoord.y = 0.5 * (1.0 - vert.y + u_inv_viewport_height);\n}";var radialBlur_fshader="#ifdef GL_ES\nprecision highp float;\n#endif\nvec2 poissonDisk[16];\nuniform sampler2D basemap;\nuniform float u_mapSize;\nuniform float u_sampRadius;\nuniform int u_numSamples;\nvarying vec2 vTexcoord;\nfloat radialBlur(sampler2D map, vec2 coord);\nvoid main()\n{\n   gl_FragColor =  vec4(0.0, 0.0, 0.0, radialBlur(basemap, vTexcoord));\n}\nfloat radialBlur(sampler2D map, vec2 coord)\n{\nfloat texmapscale = 1.0/u_mapSize;\npoissonDisk[0] = vec2( -0.94201624, -0.39906216 );\npoissonDisk[1] = vec2( 0.94558609, -0.76890725 );\npoissonDisk[2] = vec2( -0.094184101, -0.92938870);\npoissonDisk[3] = vec2( 0.34495938, 0.29387760 );\npoissonDisk[4] = vec2( -0.91588581, 0.45771432 );\npoissonDisk[5] = vec2( -0.81544232, -0.87912464 );\npoissonDisk[6] = vec2( -0.38277543, 0.27676845 );\npoissonDisk[7] = vec2( 0.97484398, 0.75648379 );\npoissonDisk[8] = vec2( 0.44323325, -0.97511554 );\npoissonDisk[9] = vec2( 0.53742981, -0.47373420 );\npoissonDisk[10] = vec2( -0.26496911, -0.41893023 );\npoissonDisk[11] = vec2( 0.79197514, 0.19090188 );\npoissonDisk[12] = vec2( -0.24188840, 0.99706507 );\npoissonDisk[13] = vec2( -0.81409955, 0.91437590 );\npoissonDisk[14] = vec2( 0.19984126, 0.78641367 );\npoissonDisk[15] = vec2( 0.14383161, -0.14100790 );\nfloat sum = 0.0;\nfloat a = 0.0;\nfor(int i = 0; i < u_numSamples ;i++)\n{\nvec2 offset = poissonDisk[i]*u_sampRadius;\na += texture2D(map, coord.xy + offset*texmapscale).w;\n}\nreturn a/float(u_numSamples);\n}";var shadowProj_vshader="attribute vec3 vert;\nattribute vec3 normal;\nattribute vec2 texcoord;\nuniform mat4 u_mvMatrix;\nuniform mat4 u_projMatrix;\nuniform mat4 u_shadowLightWorld;\nuniform mat4 u_shadowBiasMatrix;\nuniform mat4 u_vShadowLight;\nvarying vec4 vShadowCoord;\nvoid main()\n{\n\tvec4 pos\t    = (u_mvMatrix*vec4(vert, 1.0));\n\tgl_Position\t= u_projMatrix * pos;\n\tmat4 shadowMat  = u_shadowBiasMatrix*u_projMatrix*u_vShadowLight;\n   vShadowCoord    = shadowMat * vec4(vert, 1.0);\n}";var shadowProj_fshader="#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D shadowMap;\nvarying vec4 vShadowCoord;\nvoid main()\n{\n\tvec4 shadowCoord    = vec4(vShadowCoord.xyz / vShadowCoord.w, vShadowCoord.w);\n\tvec4 shadow = texture2D(shadowMap, shadowCoord.xy);\n   float alpha = 1.0 - dot(shadow.rgb, vec3(1.0, 1.0, 1.0))/2.0;\n\tgl_FragColor = vec4(0.0, 0.0, 0.0, shadow.a);\n}";function loadObjVertexMtrl(a){var f=new XMLHttpRequest;f.obj={meshObj:a};f.onreadystatechange=function(){onResponseLoadVerts(f)};f.open("GET",a.meshDataSrc.vertexData,true);var g=new XMLHttpRequest;g.obj={meshObj:a};g.onreadystatechange=function(){onResponseLoadMtrl(g)};g.open("GET",a.meshDataSrc.mtrl,true);g.send(null);f.send(null)}function onResponseLoadMtrl(a){if(a.readyState==4){a.obj.meshObj.mtrlData=a.responseText;a.obj.meshObj.preInit()}}
function onResponseLoadVerts(a){if(a.readyState==4){a.obj.meshObj.vertexData=a.responseText;a.obj.meshObj.preInit()}}function processMatVertData(a){var f=procObjMtrl(a.mtrlData);a.vertexData=procObjVertices(a.primSets,f,a.vertexData)}
function procObjMtrl(a){var f=[];a=a.split("newmtl");for(var g=new TextureSet,i=new TextureSet,h=0;h<a.length;h++){var k=new Material,j=a[h].split("\n");if(j.length!=1){k.name=j[0].substring(1);j=j.slice(1);for(var o=0;o<j.length;o++){var l=j[o].replace(/[ \t]+/g," ").replace(/\s\s*$/,"");if(l[0]!="#"){l=l.split(" ");if(l[0]=="Ka"){k.amb.x=l[1];k.amb.y=l[2];k.amb.z=l[3];if(l.length>4)k.amb.w=l[4]}else if(l[0]=="Kd"){k.diff.x=l[1];k.diff.y=l[2];k.diff.z=l[3];if(l.length>4)k.diff.w=l[4]}else if(l[0]==
"Ks"){k.spec.x=l[1];k.spec.y=l[2];k.spec.z=l[3];if(l.length>4)k.spec.w=l[4]}else if(l[0]=="Ns")k.pwr=l[1];else if(l[0]=="map_set1"){g.name=l[1];k.tex.set1.push(g_texMan.getTextureSetByName(g.name))}else if(l[0]=="map_set2"){i.name=l[1];k.tex.set2.push(g_texMan.getTextureSetByName(i.name))}else if(l[0]=="map_Kd"){g.diff=l[1];k.tex.diffuse1.push(g_texMan.loadTexture(l[1]))}else if(l[0]=="map_Kd2"){i.diff=l[1];k.tex.diffuse2.push(g_texMan.loadTexture(l[1]))}else if(l[0]=="map_Ks"){g.spec=l[1];k.tex.spec1.push(g_texMan.loadSpecMap(l[1]))}else if(l[0]==
"map_Ks2"){i.spec=l[1];k.tex.spec2.push(g_texMan.loadSpecMap(l[1]))}else if(l[0]=="bump"){g.norm=l[1];k.tex.normal1.push(g_texMan.loadNormalMap(l[1]))}else if(l[0]=="bump2"){i.norm=l[1];k.tex.normal2.push(g_texMan.loadNormalMap(l[1]))}else if(l[0]!="shader")if(l[0]=="pickable")k.pickable=l[1]=="true"?true:false}}k.name!=null&&f.push(k)}}return f}
function procObjVertices(a,f,g){var i=new MeshData,h=[],k=[],j=[],o=[],l=null;for(var n in f){subArr=[];o.push(subArr);o[n].points=[]}var p=[],q=[],t=[],r={};n=0;g=g.split("\n");for(var u=0;u<g.length;u++){var s=g[u].replace(/[ \t]+/g," ").replace(/\s\s*$/,"");if(s[0]!="#"){s=s.split(" ");if(s[0]=="usemtl")l=s[1];else if(s[0]=="v"){p.push(parseFloat(s[1]));p.push(parseFloat(s[2]));p.push(parseFloat(s[3]))}else if(s[0]=="vt"){t.push(parseFloat(s[1]));t.push(parseFloat(s[2]))}else if(s[0]=="vn"){q.push(parseFloat(s[1]));
q.push(parseFloat(s[2]));q.push(parseFloat(s[3]))}else if(s[0]=="f")if(s.length==4)for(var v=1;v<4;++v){if(!(s[v]in r)){var w=s[v].split("/"),x,B;if(w.length==1)B=w=x=parseInt(w[0])-1;else if(w.length=3){x=parseInt(w[0])-1;B=parseInt(w[1])-1;w=parseInt(w[2])-1}else return null;var y=0,z=0,A=0;if(x*3+2<p.length){y=p[x*3];z=p[x*3+1];A=p[x*3+2]}h.push(y);h.push(z);h.push(A);x=getIndexOfName(f,l);o[x].points.push(y);o[x].points.push(z);o[x].points.push(A);z=y=0;if(B*2+1<t.length){y=t[B*2];z=t[B*2+1]}j.push(y);
j.push(z);z=y=0;A=1;if(w*3+2<q.length){y=q[w*3];z=q[w*3+1];A=q[w*3+2]}k.push(y);k.push(z);k.push(A);r[s[v]]=n++}x=getIndexOfName(f,l);o[x].push(r[s[v]])}}}i.vertexObject=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,i.vertexObject);gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(h),gl.STATIC_DRAW);i.normalObject=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,i.normalObject);gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(k),gl.STATIC_DRAW);i.texCoordObject=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,
i.texCoordObject);gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(j),gl.STATIC_DRAW);h=Array(3E4);for(n=j=k=0;n<f.length;n++){a.push({size:0,indexInBuffer:k,points:o[n].points,material:f[n]});for(l=0;l<o[n].length;l++)h[j++]=o[n][l];a[n].size=l;k+=o[n].length}h=h.slice(0,j);i.numIndices=h.length;i.indexObject=gl.createBuffer();gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,i.indexObject);gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,new Uint16Array(h),gl.STREAM_DRAW);return i}
function getIndexOfName(a,f){for(var g=0;g<a.length;g++)if(f==a[g].name)return g;return 0};function __UNIFORMTYPE(){this.INT=1008;this.FLOAT=1E3;this.FLOAT2=1001;this.FLOAT3=1002;this.FLOAT4=1003;this.MATRIX3=1004;this.MATRIX4=1005;this.TEXTURE2D=1006;this.TEXTURECUBE=1007}UNIFORMTYPE=new __UNIFORMTYPE;function RenderObject(a){this.shader=a;this.world=null;this.bindings=new ShaderData;this.postRenderProc=this.renderProc=this.initRenderProc=null}
RenderObject.prototype.addUniform=function(a,f,g){var i=gl.getUniformLocation(this.shader,a);if(i){i.debugName=a;this.bindings.uniforms.push(new UniformPair(i,f,g))}};RenderObject.prototype.addUniformArray=function(a,f,g,i){var h=gl.getUniformLocation(this.shader,a);if(h)for(;0<i;){h.debugName=a+0;this.bindings.uniforms.push(new UniformPair(h,f[0],g));h+=f[0].length;f++}};
RenderObject.prototype.addTexture=function(a,f,g){(a=gl.getUniformLocation(this.shader,a))&&this.bindings.textures.push(new TexUniform(a,f,g))};RenderObject.prototype.addBuffers=function(a,f,g,i,h){g==undefined||i==undefined||h==undefined||g==null||i==null||h==null?this.bindings.buffers.push(new BufferAttrib(a,f,null,null,null)):this.bindings.buffers.push(new BufferAttrib(a,f,g,i,h))};
RenderObject.prototype.bindUniforms=function(){for(var a=0;a<this.bindings.uniforms.length;a++){var f=this.bindings.uniforms[a];switch(f.type){case UNIFORMTYPE.INT:gl.uniform1i(f.uniform,f.value);break;case UNIFORMTYPE.FLOAT:gl.uniform1f(f.uniform,f.value);break;case UNIFORMTYPE.FLOAT2:gl.uniform2fv(f.uniform,f.value.getAsWebGLFloatArray());break;case UNIFORMTYPE.FLOAT3:gl.uniform3fv(f.uniform,f.value.getAsWebGLFloatArray());break;case UNIFORMTYPE.FLOAT4:gl.uniform4fv(f.uniform,f.value.getAsWebGLFloatArray());
break;case UNIFORMTYPE.MATRIX3:gl.uniformMatrix3fv(f.uniform,false,f.value.getAsWebGLFloatArray());break;case UNIFORMTYPE.MATRIX4:gl.uniformMatrix4fv(f.uniform,false,f.value.getAsWebGLFloatArray());break;default:break}}};
RenderObject.prototype.bindTextures=function(){for(var a=0;a<this.bindings.textures.length;a++){var f=this.bindings.textures[a];switch(f.type){case UNIFORMTYPE.TEXTURE2D:gl.activeTexture(gl.TEXTURE0+f.unit);gl.uniform1i(f.uniform,f.unit);break;case UNIFORMTYPE.TEXTURECUBE:gl.activeTexture(gl.TEXTURE0+f.unit);gl.uniform1i(f.uniform,f.unit);break;default:break}}};
RenderObject.prototype.bindBuffers=function(){for(var a=0;a<this.bindings.buffers.length;a++){var f=this.bindings.buffers[a];gl.bindBuffer(f.glBufferType,f.buffer);if(f.glAttribType!=null){gl.enableVertexAttribArray(f.attribIndex);gl.vertexAttribPointer(f.attribIndex,f.attribSize,f.glAttribType,false,0,0)}}};
RenderObject.prototype.unBindBuffers=function(){for(var a=0;a<this.bindings.buffers.length;a++){var f=this.bindings.buffers[a];f.glAttribType!=null&&gl.disableVertexAttribArray(f.attribIndex);gl.bindBuffer(f.glBufferType,null)}};RenderObject.prototype.initialize=function(a){a(this)};RenderObject.prototype.clear=function(){this.world=new CanvasMatrix4;this.bindings=new ShaderData};function ShaderData(){this.uniforms=[];this.textures=[];this.buffers=[]}
function UniformPair(a,f,g){this.uniform=a;this.value=f;this.type=g}function TexUniform(a,f,g){this.uniform=a;this.unit=f;this.type=g}function BufferAttrib(a,f,g,i,h){this.buffer=a;this.glBufferType=f;this.attribSize=g;this.glAttribType=h;this.attribIndex=i}renderProcDefault=__renderProcDefault;postRenderProcDefault=__postRenderProcDefault;renderProcLines=__renderProcLines;renderProcScreenQuad=__renderProcScreenQuad;renderProcDepthMap=__renderProcDepthMap;renderProcShadowReceiver=__renderProcShadowReceiver;
renderProcShadowProjection=__renderProcShadowProjection;function __setActiveTexture(a,f){gl.activeTexture(a);gl.bindTexture(gl.TEXTURE_2D,f)}
function __renderProcDefault(a){gl.mvMatrix.load(g_cam.view);gl.mvMatrix.multRight(a.parentMesh.world);gl.normalMatrix.load(gl.mvMatrix);gl.normalMatrix.invert();gl.normalMatrix.transpose();gl.invMvMatrix.load(gl.mvMatrix);gl.invMvMatrix.invert();gl.useProgram(arrayPeek(a.material.shader).shaderHandle);gl.activeTexture(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,arrayPeek(a.material.tex.set1).diff);gl.activeTexture(gl.TEXTURE1);gl.bindTexture(gl.TEXTURE_2D,arrayPeek(a.material.tex.set2).diff);gl.activeTexture(gl.TEXTURE2);
gl.bindTexture(gl.TEXTURE_2D,arrayPeek(a.material.tex.set1).spec);gl.activeTexture(gl.TEXTURE3);gl.bindTexture(gl.TEXTURE_2D,arrayPeek(a.material.tex.set2).spec);gl.activeTexture(gl.TEXTURE4);gl.bindTexture(gl.TEXTURE_2D,arrayPeek(a.material.tex.env));gl.activeTexture(gl.TEXTURE5);gl.bindTexture(gl.TEXTURE_2D,arrayPeek(a.material.tex.envDiff));__setActiveTexture(gl.TEXTURE7,g_cam.stickerTexture[0]);__setActiveTexture(gl.TEXTURE8,g_cam.stickerTexture[1]);__setActiveTexture(gl.TEXTURE9,g_cam.stickerTexture[2]);
__setActiveTexture(gl.TEXTURE10,g_cam.stickerTexture[3]);__setActiveTexture(gl.TEXTURE11,g_cam.stickerTexture[4]);__setActiveTexture(gl.TEXTURE12,g_cam.stickerTexture[5]);__setActiveTexture(gl.TEXTURE13,g_cam.stickerTexture[6]);__setActiveTexture(gl.TEXTURE14,g_cam.stickerTexture[7]);for(var f=0;f<8;f++){a.parentMesh.stickers[f].load(g_cam.stickers[f]);a.parentMesh.stickersPos[f].setvec(g_cam.stickersPos[f])}__setActiveTexture(gl.TEXTURE15,arrayPeek(a.material.tex.set1).norm);__setActiveTexture(gl.TEXTURE6,
arrayPeek(a.material.tex.set2).norm);arrayPeek(a.material.renderObj).bindBuffers();arrayPeek(a.material.renderObj).bindTextures();arrayPeek(a.material.renderObj).bindUniforms();gl.drawElements(gl.TRIANGLES,a.size,gl.UNSIGNED_SHORT,a.indexInBuffer*2)}function __renderProcLines(a,f,g,i,h){gl.useProgram(a.shader);a.lineColor.x=f;a.lineColor.y=g;a.lineColor.z=i;a.lineColor.w=h;a.bindBuffers();a.bindUniforms();gl.drawArrays(gl.LINES,0,a.numPoints/3);gl.useProgram(null)}
function __renderProcScreenQuad(a){gl.disable(gl.DEPTH_TEST);gl.useProgram(a.shader);a.renderObj.bindBuffers();a.renderObj.bindTextures();a.renderObj.bindUniforms();gl.bindTexture(gl.TEXTURE_2D,a.texture);gl.drawArrays(gl.TRIANGLES,0,6);gl.useProgram(null);gl.enable(gl.DEPTH_TEST)}function __postRenderProcDefault(a){gl.useProgram(arrayPeek(a.material.renderObj).shader);gl.useProgram(null)}
function __renderProcDepthMap(a){gl.useProgram(g_depthMap.shader);arrayPeek(a.material.renderObj).bindBuffers();g_depthMap.bindUniforms();gl.enable(gl.DEPTH_TEST);gl.enable(gl.CULL_FACE);gl.enable(gl.POLYGON_OFFSET_FILL);gl.cullFace(gl.FRONT);gl.drawElements(gl.TRIANGLES,a.size,gl.UNSIGNED_SHORT,a.indexInBuffer*2);gl.cullFace(gl.BACK);gl.disable(gl.POLYGON_OFFSET_FILL);gl.disable(gl.CULL_FACE);gl.useProgram(null)}
function __renderProcShadowReceiver(a){gl.bindFramebuffer(gl.FRAMEBUFFER,a.shadowTarget.frameBuffer);gl.viewport(0,0,a.shadowTarget.frameBuffer.width,a.shadowTarget.frameBuffer.height);gl.clearDepth(g_farZ);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);gl.useProgram(arrayPeek(a.material.shader).shaderHandle);gl.activeTexture(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,g_depthMap.depthRT);arrayPeek(a.material.renderObj).bindTextures();gl.mvMatrix.load(g_defaultView);gl.mvMatrix.multRight(a.parentMesh.world);
arrayPeek(a.material.renderObj).bindUniforms();error=gl.getError();arrayPeek(a.material.renderObj).bindBuffers();gl.drawElements(gl.TRIANGLES,a.size,gl.UNSIGNED_SHORT,a.indexInBuffer*2);gl.useProgram(null);gl.bindTexture(gl.TEXTURE_2D,a.shadowTarget);gl.generateMipmap(gl.TEXTURE_2D);gl.bindTexture(gl.TEXTURE_2D,null);gl.bindFramebuffer(gl.FRAMEBUFFER,theSceneRTT.frameBuffer);gl.viewport(0,0,theSceneRTT.frameBuffer.width,theSceneRTT.frameBuffer.height);gl.bindFramebuffer(gl.FRAMEBUFFER,a.shadowTargetFinal.frameBuffer);
gl.viewport(0,0,a.shadowTargetFinal.frameBuffer.width,a.shadowTargetFinal.frameBuffer.height);gl.clearDepth(g_farZ);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);a.screenQuad.setTexture(a.shadowTarget);a.screenQuad.render(renderProcScreenQuad);gl.bindTexture(gl.TEXTURE_2D,a.shadowTargetFinal);gl.generateMipmap(gl.TEXTURE_2D);gl.bindTexture(gl.TEXTURE_2D,null);gl.bindFramebuffer(gl.FRAMEBUFFER,theSceneRTT.frameBuffer);gl.viewport(0,0,theSceneRTT.frameBuffer.width,theSceneRTT.frameBuffer.height);
gl.bindFramebuffer(gl.FRAMEBUFFER,a.shadowTarget.frameBuffer);gl.viewport(0,0,a.shadowTarget.frameBuffer.width,a.shadowTarget.frameBuffer.height);gl.clearDepth(g_farZ);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);a.screenQuad.setTexture(a.shadowTargetFinal);a.screenQuad.render(renderProcScreenQuad);gl.bindTexture(gl.TEXTURE_2D,a.shadowTarget);gl.generateMipmap(gl.TEXTURE_2D);gl.bindTexture(gl.TEXTURE_2D,null);gl.bindFramebuffer(gl.FRAMEBUFFER,theSceneRTT.frameBuffer);gl.viewport(0,0,theSceneRTT.frameBuffer.width,
theSceneRTT.frameBuffer.height)}
function __renderProcShadowProjection(a){gl.useProgram(arrayPeek(a.material.shader).shaderHandle);gl.getError();gl.activeTexture(gl.TEXTURE0);gl.getError(gl.bindTexture(gl.TEXTURE_2D,g_depthMap.shadowTarget));gl.bindTexture(gl.TEXTURE_2D,g_meshMan.getModelByName("backdropReceiver").mesh.shadowToProject);arrayPeek(a.material.renderObj).bindTextures();gl.mvMatrix.load(g_defaultView);gl.mvMatrix.multRight(a.parentMesh.world);arrayPeek(a.material.renderObj).bindUniforms();arrayPeek(a.material.renderObj).bindBuffers();
gl.drawElements(gl.TRIANGLES,a.size,gl.UNSIGNED_SHORT,a.indexInBuffer*2);gl.useProgram(null)};renderInitProcDefault=__renderInitProcDefault;renderInitScreenQuad=__renderInitScreenQuad;renderInitProcDepthMap=__renderInitProcDepthMap;renderInitShadowReceiver=__renderInitShadowReceiver;renderInitShadowProjection=__renderInitShadowProjection;
function __renderInitProcDefault(a,f){var g=a.material;g.tex.env.push(arrayPeek(g.shader).envMap);g.tex.envDiff.push(arrayPeek(g.shader).envDiff);gl.useProgram(arrayPeek(g.shader).shaderHandle);arrayPeek(g.renderObj).addTexture("layerMap1",0,UNIFORMTYPE.TEXTURE2D);arrayPeek(g.renderObj).addTexture("layerMap2",1,UNIFORMTYPE.TEXTURE2D);arrayPeek(g.renderObj).addTexture("colorMeMap1",2,UNIFORMTYPE.TEXTURE2D);arrayPeek(g.renderObj).addTexture("colorMeMap2",3,UNIFORMTYPE.TEXTURE2D);arrayPeek(g.renderObj).addTexture("envMap",
4,UNIFORMTYPE.TEXTURE2D);arrayPeek(g.renderObj).addTexture("envDiff",5,UNIFORMTYPE.TEXTURE2D);arrayPeek(g.renderObj).addTexture("normalMap1",15,UNIFORMTYPE.TEXTURE2D);arrayPeek(g.renderObj).addTexture("normalMap2",6,UNIFORMTYPE.TEXTURE2D);arrayPeek(g.renderObj).addTexture("stickerMap0",7,UNIFORMTYPE.TEXTURE2D);arrayPeek(g.renderObj).addTexture("stickerMap1",8,UNIFORMTYPE.TEXTURE2D);arrayPeek(g.renderObj).addTexture("stickerMap2",9,UNIFORMTYPE.TEXTURE2D);arrayPeek(g.renderObj).addTexture("stickerMap3",
10,UNIFORMTYPE.TEXTURE2D);arrayPeek(g.renderObj).addTexture("stickerMap4",11,UNIFORMTYPE.TEXTURE2D);arrayPeek(g.renderObj).addTexture("stickerMap5",12,UNIFORMTYPE.TEXTURE2D);arrayPeek(g.renderObj).addTexture("stickerMap6",13,UNIFORMTYPE.TEXTURE2D);arrayPeek(g.renderObj).addTexture("stickerMap7",14,UNIFORMTYPE.TEXTURE2D);arrayPeek(g.renderObj).addUniform("u_normalMatrix",gl.normalMatrix,UNIFORMTYPE.MATRIX4);arrayPeek(g.renderObj).addUniform("u_mvMatrix",gl.mvMatrix,UNIFORMTYPE.MATRIX4);arrayPeek(g.renderObj).addUniform("u_invMvMatrix",
gl.invMvMatrix,UNIFORMTYPE.MATRIX4);arrayPeek(g.renderObj).addUniform("u_stickerMatrix0",a.parentMesh.stickers[0],UNIFORMTYPE.MATRIX4);arrayPeek(g.renderObj).addUniform("u_stickerMatrix1",a.parentMesh.stickers[1],UNIFORMTYPE.MATRIX4);arrayPeek(g.renderObj).addUniform("u_stickerMatrix2",a.parentMesh.stickers[2],UNIFORMTYPE.MATRIX4);arrayPeek(g.renderObj).addUniform("u_stickerMatrix3",a.parentMesh.stickers[3],UNIFORMTYPE.MATRIX4);arrayPeek(g.renderObj).addUniform("u_stickerMatrix4",a.parentMesh.stickers[4],
UNIFORMTYPE.MATRIX4);arrayPeek(g.renderObj).addUniform("u_stickerMatrix5",a.parentMesh.stickers[5],UNIFORMTYPE.MATRIX4);arrayPeek(g.renderObj).addUniform("u_stickerMatrix6",a.parentMesh.stickers[6],UNIFORMTYPE.MATRIX4);arrayPeek(g.renderObj).addUniform("u_stickerMatrix7",a.parentMesh.stickers[7],UNIFORMTYPE.MATRIX4);arrayPeek(g.renderObj).addUniform("u_stickerPos0",a.parentMesh.stickersPos[0],UNIFORMTYPE.FLOAT3);arrayPeek(g.renderObj).addUniform("u_stickerPos1",a.parentMesh.stickersPos[1],UNIFORMTYPE.FLOAT3);
arrayPeek(g.renderObj).addUniform("u_stickerPos2",a.parentMesh.stickersPos[2],UNIFORMTYPE.FLOAT3);arrayPeek(g.renderObj).addUniform("u_stickerPos3",a.parentMesh.stickersPos[3],UNIFORMTYPE.FLOAT3);arrayPeek(g.renderObj).addUniform("u_stickerPos4",a.parentMesh.stickersPos[4],UNIFORMTYPE.FLOAT3);arrayPeek(g.renderObj).addUniform("u_stickerPos5",a.parentMesh.stickersPos[5],UNIFORMTYPE.FLOAT3);arrayPeek(g.renderObj).addUniform("u_stickerPos6",a.parentMesh.stickersPos[6],UNIFORMTYPE.FLOAT3);arrayPeek(g.renderObj).addUniform("u_stickerPos7",
a.parentMesh.stickersPos[7],UNIFORMTYPE.FLOAT3);arrayPeek(g.renderObj).addUniform("u_projMatrix",gl.perspectiveMatrix,UNIFORMTYPE.MATRIX4);arrayPeek(g.renderObj).addUniform("u_fillColor1",g.fillColor[0],UNIFORMTYPE.FLOAT4);arrayPeek(g.renderObj).addUniform("u_fillColor2",g.fillColor[1],UNIFORMTYPE.FLOAT4);arrayPeek(g.renderObj).addUniform("u_skinColor",g.fillColor[2],UNIFORMTYPE.FLOAT4);f.vertexObject.name="vertexObject";f.normalObject.name="normalObject";f.texCoordObject.name="texCoordObject";f.indexObject.name=
"indexObject";arrayPeek(g.renderObj).addBuffers(f.vertexObject,gl.ARRAY_BUFFER,3,0,gl.FLOAT);arrayPeek(g.renderObj).addBuffers(f.normalObject,gl.ARRAY_BUFFER,3,1,gl.FLOAT);arrayPeek(g.renderObj).addBuffers(f.texCoordObject,gl.ARRAY_BUFFER,2,2,gl.FLOAT);arrayPeek(g.renderObj).addBuffers(f.indexObject,gl.ELEMENT_ARRAY_BUFFER);gl.useProgram(null)}
function __renderInitScreenQuad(a,f){a.shader=f==undefined?createShader(gl,screenQuad_vShader,screenQuad_fShader,["vert","texcoord"]):f;a.renderObj=new RenderObject(a.shader);quadBuf=getScreenAlignedQuad();a.vertBuffer=quadBuf.vertexObject;a.uvBuffer=quadBuf.texCoordObject;a.renderObj.addTexture("basemap",0,UNIFORMTYPE.TEXTURE2D);a.renderObj.addUniform("u_inv_viewport_width",1/g_width,UNIFORMTYPE.FLOAT);a.renderObj.addUniform("u_inv_viewport_height",1/g_height,UNIFORMTYPE.FLOAT);a.renderObj.addBuffers(a.vertBuffer,
gl.ARRAY_BUFFER,3,0,gl.FLOAT);a.renderObj.addBuffers(a.uvBuffer,gl.ARRAY_BUFFER,2,2,gl.FLOAT)}function __renderInitProcDepthMap(a){a.shader=g_depthShader.shaderHandle;gl.useProgram(a.shader);a.addUniform("u_mvpLightMatrix",g_mainLight.mvpMatrix,UNIFORMTYPE.MATRIX4);a.bindUniforms();gl.useProgram(null)}
function __renderInitShadowReceiver(a,f){a.shadowTarget=g_texMan.loadRenderTarget("shadowTarget",256,256);a.shadowTargetFinal=g_texMan.loadRenderTarget("shadowTargetFinal",256,256);a.screenQuad=new ScreenQuad(a.shadowTargetFinal);a.screenQuad.initialize(__renderInitRadialBlur);a.parentMesh.shadowToProject=a.shadowTarget;var g=a.material;g.tex.env.push(arrayPeek(g.shader).envMap);g.tex.envDiff.push(arrayPeek(g.shader).envDiff);gl.useProgram(arrayPeek(g.shader).shaderHandle);arrayPeek(g.renderObj).addTexture("shadowMap",
0,UNIFORMTYPE.TEXTURE2D);arrayPeek(g.renderObj).addUniform("u_mvMatrix",gl.mvMatrix,UNIFORMTYPE.MATRIX4);arrayPeek(g.renderObj).addUniform("u_projMatrix",gl.perspectiveMatrix,UNIFORMTYPE.MATRIX4);arrayPeek(g.renderObj).addUniform("u_shadowBiasMatrix",g_mainLight.shadowMatrix,UNIFORMTYPE.MATRIX4);arrayPeek(g.renderObj).addUniform("u_vShadowLight",g_mainLight.view,UNIFORMTYPE.MATRIX4);f.vertexObject.name="vertexObject";f.normalObject.name="normalObject";f.texCoordObject.name="texCoordObject";f.indexObject.name=
"indexObject";arrayPeek(g.renderObj).addBuffers(f.vertexObject,gl.ARRAY_BUFFER,3,0,gl.FLOAT);arrayPeek(g.renderObj).addBuffers(f.normalObject,gl.ARRAY_BUFFER,3,1,gl.FLOAT);arrayPeek(g.renderObj).addBuffers(f.texCoordObject,gl.ARRAY_BUFFER,2,2,gl.FLOAT);arrayPeek(g.renderObj).addBuffers(f.indexObject,gl.ELEMENT_ARRAY_BUFFER);gl.useProgram(null)}
function __renderInitShadowProjection(a,f){var g=a.material;gl.useProgram(arrayPeek(g.shader).shaderHandle);arrayPeek(g.renderObj).addTexture("shadowMap",0,UNIFORMTYPE.TEXTURE2D);arrayPeek(g.renderObj).addUniform("u_mvMatrix",gl.mvMatrix,UNIFORMTYPE.MATRIX4);arrayPeek(g.renderObj).addUniform("u_projMatrix",gl.perspectiveMatrix,UNIFORMTYPE.MATRIX4);arrayPeek(g.renderObj).addUniform("u_shadowBiasMatrix",g_mainLight.shadowMatrix,UNIFORMTYPE.MATRIX4);arrayPeek(g.renderObj).addUniform("u_vShadowLight",
g_mainLight.view,UNIFORMTYPE.MATRIX4);f.vertexObject.name="vertexObject";f.normalObject.name="normalObject";f.texCoordObject.name="texCoordObject";f.indexObject.name="indexObject";arrayPeek(g.renderObj).addBuffers(f.vertexObject,gl.ARRAY_BUFFER,3,0,gl.FLOAT);arrayPeek(g.renderObj).addBuffers(f.normalObject,gl.ARRAY_BUFFER,3,1,gl.FLOAT);arrayPeek(g.renderObj).addBuffers(f.texCoordObject,gl.ARRAY_BUFFER,2,2,gl.FLOAT);arrayPeek(g.renderObj).addBuffers(f.indexObject,gl.ELEMENT_ARRAY_BUFFER);gl.useProgram(null)}
function __renderInitRadialBlur(a,f){a.shader=f==undefined?createShader(gl,radialBlur_vshader,radialBlur_fshader,["vert","texcoord"]):f;a.renderObj=new RenderObject(a.shader);quadBuf=getScreenAlignedQuad();a.vertBuffer=quadBuf.vertexObject;a.uvBuffer=quadBuf.texCoordObject;a.renderObj.addTexture("basemap",0,UNIFORMTYPE.TEXTURE2D);a.renderObj.addUniform("u_inv_viewport_width",1/g_width,UNIFORMTYPE.FLOAT);a.renderObj.addUniform("u_inv_viewport_height",1/g_height,UNIFORMTYPE.FLOAT);a.renderObj.addUniform("u_sampRadius",
5,UNIFORMTYPE.FLOAT);a.renderObj.addUniform("u_numSamples",16,UNIFORMTYPE.INT);a.renderObj.addUniform("u_mapSize",256,UNIFORMTYPE.FLOAT);a.renderObj.addBuffers(a.vertBuffer,gl.ARRAY_BUFFER,3,0,gl.FLOAT);a.renderObj.addBuffers(a.uvBuffer,gl.ARRAY_BUFFER,2,2,gl.FLOAT)};function CollisionManager(){this.BV=[]};function Model(a,f){this.name=a;this.mesh=f;this.camera=null}function MeshManager(){this.modelList=[];this.readyList=[];this.meshesLoading=true;this.postMeshLoadCallbackList=[]}MeshManager.prototype.loadMesh=function(a,f,g,i){f=new Mesh({vertexData:f,mtrl:g});f.defaultShaderName=i;this.readyList.push(new Model(a,f));f.loadMesh()};MeshManager.prototype.getModelByName=function(a){for(var f in this.modelList)if(a==this.modelList[f].name)return this.modelList[f];this.meshToAdd=a;return null};
MeshManager.prototype.getModelNames=function(){var a=[];for(var f in this.modelList)a.push(this.modelList[f].name);return a};MeshManager.prototype.setModelCamera=function(a){a=this.getModelByName(a);if(a.camera==null)a.camera=new camera;a.camera.copy(g_cam)};MeshManager.prototype.getModelCamera=function(a){(a=this.getModelByName(a))&&a.camera?g_cam.copy(a.camera):g_cam.clearstickers();g_cam.updateStickerCounter()};
MeshManager.prototype.addToScene=function(a){var f=this.getModelByName(a);if(f)g_worldObjects.push(f);else this.meshToAdd=a;return null};
MeshManager.prototype.processMeshData=function(){for(var a in this.readyList)if(this.readyList[a]&&this.readyList[a].mesh.readyToProcess){var f=this.readyList[a];this.readyList.splice(a,1);f.mesh.initialize();this.modelList.push(f);if(this.meshToAdd)if(this.meshToAdd==f.name){g_worldObjects.push(f);this.meshToAdd=null}this.readyList.length==0&&g_initComplete==true&&this.onLoaded();break}};MeshManager.prototype.addOnLoadedCallback=function(a){this.postMeshLoadCallbackList.push(a)};
MeshManager.prototype.onLoaded=function(){for(var a=0 in this.postMeshLoadCallbackList)this.postMeshLoadCallbackList[a]()};function TextureSet(){this.name="unnamed";this.norm=this.spec=this.diff=g_alphaTex;this.layer=0;this.partName=null}function TextureManager(){this.textureMap=[];this.rttMap=[];this.materialMap=[];this.normalMap=[];this.specMap=[];this.textureSetMap=[]}TextureManager.prototype.loadTexture=function(a){return this.loadTexAddToMap(this.textureMap,a)};
TextureManager.prototype.loadTextureSet=function(a,f,g,i,h,k){if(this.textureSetMap[a]==undefined){var j=new TextureSet;j.diff=f&&f.image?f:f==undefined?null:this.loadTexAddToMap(this.textureMap,f);j.spec=g&&g.image?g:g==undefined?null:this.loadTexAddToMap(this.specMap,g);j.norm=i&&i.image?i:i==undefined?null:this.loadTexAddToMap(this.normalMap,i);j.diff=j.diff==null||j.diff==undefined?g_alphaTex:j.diff;j.spec=j.spec==null||j.diff==undefined?g_alphaTex:j.spec;j.norm=j.norm==null||j.diff==undefined?
h==0?g_defaultNorm1:g_defaultNorm2:j.norm;j.layer=h;j.partName=k;j.name=a;this.textureSetMap[a]=j;this.textureSetMap[a].name=a}return this.textureSetMap[a]};TextureManager.prototype.loadRenderTarget=function(a,f,g){if(this.rttMap[a]==undefined){this.rttMap[a]=createRenderTargetTexture(f,g);if(this.rttMap[a]!=null)this.rttMap[a].name=a}return this.rttMap[a]};TextureManager.prototype.loadMaterial=function(a){return this.loadTexAddToMap(this.materialMap,a)};
TextureManager.prototype.loadNormalMap=function(a){return this.loadTexAddToMap(this.normalMap,a)};TextureManager.prototype.loadSpecMap=function(a){return this.loadTexAddToMap(this.specMap,a)};TextureManager.prototype.loadTexAddToMap=function(a,f){if(a[f]==undefined){a[f]=loadImageTexture(gl,"content/texture/"+f);a[f].name=f}return a[f]};TextureManager.prototype.addTexture=function(a,f){this.textureMap[a]=f};
TextureManager.prototype.getTextureSetNames=function(){var a=[];for(var f in this.textureSetMap)a.push(this.textureSetMap[f].name);return a};TextureManager.prototype.getTextureSetNamesByLayerAndPart=function(a,f){var g=[];for(var i in this.textureSetMap)this.textureSetMap[i].layer==a&&this.textureSetMap[i].partName==f&&g.push(this.textureSetMap[i].name);return g};TextureManager.prototype.getTextureSetByName=function(a){a=this.textureSetMap[a];if(a!=undefined)return a;return null};
TextureManager.prototype.getTextureByName=function(a){var f=this.textureMap[a];if(f==undefined)f=this.rttMap[a];if(f==undefined)f=this.materialMap[a];if(f==undefined)f=this.normalMap[a];if(f==undefined)f=this.specMap[a];if(f!=undefined)return f;return null};
TextureManager.prototype.init=function(){this.loadTextureSet("defaultHead","alphaTex.png","whiteTex.png","defaultNormMap1.jpg",0,"Head");this.loadTextureSet("defaultHair","alphaTex.png","whiteTex.png","defaultNormMap2.jpg",1,"Head");this.loadTextureSet("defaultBody","alphaTex.png","whiteTex.png","defaultNormMap1.jpg",0,"Body");this.loadTextureSet("defaultLeg","alphaTex.png","whiteTex.png","defaultNormMap2.jpg",1,"Body");this.loadTexture("StampDecal_01_DM.png");this.loadTexture("StampDecal_02_DM.png");
this.loadTexture("StampDecal_03_DM.png");this.loadTexture("StampDecal_04_DM.png");this.loadTexture("StampDecal_05_DM.png");this.loadTexture("StampDecal_06_DM.png");this.loadTexture("StampDecal_07_DM.png");this.loadTexture("StampDecal_08_DM.png");this.loadTexture("StampDecal_09_DM.png");this.loadTexture("StampDecal_10_DM.png");for(var a=0;a<10;++a){var f=a<9?"0"+(a+1):a+1;this.loadTextureSet("Head"+f,"Head/HeadDecal"+f+"_DM.png","Head/HeadDecal"+f+"_ColorM.jpg","Head/HeadDecal"+f+"_NM.jpg",0,"Head");
this.loadTextureSet("Hair"+f,"Hair/HairDecal"+f+"_DM.png","Hair/HairDecal"+f+"_ColorM.jpg","Hair/HairDecal"+f+"_NM.jpg",1,"Head")}for(a=0;a<10;++a){f=a<9?"0"+(a+1):a+1;this.loadTextureSet("Body"+f,"Body/BodyDecal"+f+"_DM.png","Body/BodyDecal"+f+"_ColorM.jpg","Body/BodyDecal"+f+"_NM.jpg",1,"Body");this.loadTextureSet("Legs"+f,"Legs/LegDecal"+f+"_DM.png","Legs/LegDecal"+f+"_ColorM.jpg","Legs/LegDecal"+f+"_NM.jpg",0,"Body")}};function Shader(a,f,g,i,h){this.name=a;this.shaderHandle=f;this.initRenderProc=i;this.renderProc=g;this.postRenderProc=postRenderProcDefault;this.envDiff=this.envMap=h}function ShaderManager(){this.shaderMap=[]}
ShaderManager.prototype.addShader=function(a,f,g,i,h,k,j,o){var l=this.shaderMap[a];if(l==undefined){f=createShader(gl,f,g,i);if(j!=undefined||o!=undefined){j=g_texMan.loadMaterial(j);o=g_texMan.loadMaterial(o);this.shaderMap[a]=new Shader(a,f,h,k,j);this.shaderMap[a].envDiff=o}else{this.shaderMap[a]=new Shader(a,f,h,k,null);this.shaderMap[a].envDiff=null}this.shaderMap[a].name=a;return this.shaderMap[a]}return l};
ShaderManager.prototype.getShaderNames=function(){var a=[];for(var f in this.shaderMap)a.push(this.shaderMap[f].name);return a};ShaderManager.prototype.getShaderByName=function(a){a=this.shaderMap[a];if(a!=undefined&&a!=null)return a;return null};
ShaderManager.prototype.init=function(){this.addShader("default",vortexVShader,vortexFShader,["vert","normal","texcoord"],renderProcDefault,renderInitProcDefault,"material_DullPlastic.png","material_DullPlastic.png");this.addShader("barlights",vortexVShader,vortexFShader,["vert","normal","texcoord"],renderProcDefault,renderInitProcDefault,"material_barlights.png","material_barlightsDull.png");this.addShader("gloss",vortexVShader,vortexFShader,["vert","normal","texcoord"],renderProcDefault,renderInitProcDefault,
"material_gloss.png","material_glossDull.png");this.addShader("inGlass",vortexVShader,vortexFShader,["vert","normal","texcoord"],renderProcDefault,renderInitProcDefault,"material_inGlass.png","material_inGlassDull.png");this.addShader("normals",vortexVShader,vortexFShader,["vert","normal","texcoord"],renderProcDefault,renderInitProcDefault,"material_normal.png","material_normalDull.png");this.addShader("paint",vortexVShader,vortexFShader,["vert","normal","texcoord"],renderProcDefault,renderInitProcDefault,
"material_paint.png","material_paintDull.png");this.addShader("plastic",vortexVShader,vortexFShader,["vert","normal","texcoord"],renderProcDefault,renderInitProcDefault,"material_plastic.png","material_plasticDull.png");this.addShader("shadows",vortexVShader,vortexFShader,["vert","normal","texcoord"],renderProcDefault,renderInitProcDefault,"material_shadows.png","material_shadowsDull.png");this.addShader("skin",vortexVShader,vortexFShader,["vert","normal","texcoord"],renderProcDefault,renderInitProcDefault,
"material_skin.png","material_skinDull.png");this.addShader("wax",vortexVShader,vortexFShader,["vert","normal","texcoord"],renderProcDefault,renderInitProcDefault,"material_wax.png","material_waxDull.png");this.addShader("shadowReceiver",shadow_vshader,shadow_fshader,["vert","normal","texcoord"],renderProcShadowReceiver,renderInitShadowReceiver);this.addShader("shadowProj",shadowProj_vshader,shadowProj_fshader,["vert","normal","texcoord"],renderProcShadowProjection,renderInitShadowProjection)};function Material(){this.name=null;this.amb=new vec4(0,0,0,1);this.diff=new vec4(0,0,0,1);this.spec=new vec4(0,0,0,1);this.pwr=64;this.tex={diffuse1:[g_alphaTex],diffuse2:[g_alphaTex],spec1:[g_alphaTex],spec2:[g_alphaTex],normal1:[g_alphaTex],normal2:[g_alphaTex],env:[g_alphaTex],envDiff:[g_alphaTex],set1:[new TextureSet],set2:[new TextureSet]};this.fillColor=[new vec4(1,1,1,1),new vec4(1,1,1,1),new vec4(1,1,1,1)];this.shader=[];this.renderObj=[];this.pickable=true}
function MeshData(){this.numIndices=0;this.indexObject=this.normalObject=this.texCoordObject=this.vertexObject=this.primSets=null}function Mesh(a){this.glCtx=gl;this.meshDataSrc=a;this.mtrlData=this.vertexData=null;this.readyToProcess=this.loaded=false;this.BVL=null;this.world=new CanvasMatrix4;this.primSets=[];this.defaultShaderName="default";this.stickers=[];this.stickersPos=[];for(a=0;a<9;a++){this.stickers[a]=new CanvasMatrix4;this.stickersPos[a]=new vec3(0,0,0)}}
Mesh.prototype.loadMesh=function(){loadObjVertexMtrl(this,this.initialize)};Mesh.prototype.preInit=function(){if(this.vertexData&&this.mtrlData)this.readyToProcess=true};Mesh.prototype.initialize=function(){processMatVertData(this);for(var a in this.primSets)this.primSets[a].parentMesh=this;this.pushShaderToModel(this.defaultShaderName);this.generateMaterialBVL();this.loaded=true};
Mesh.prototype.generateMaterialBVL=function(){if(this.primSets!=undefined){this.BVL=[];for(var a=0;a<this.primSets.length;a++)if(this.primSets[a].material.pickable!=false){this.BVL.push({min:null,max:null,primSetRef:this.primSets[a]});for(var f=null,g=null,i=null,h=null,k=null,j=null,o=0,l=0,n=0,p=0;p<this.primSets[a].points.length;p+=3){o=this.primSets[a].points[p];l=this.primSets[a].points[p+1];n=this.primSets[a].points[p+2];if(o<f||f==null)f=o;if(l<g||g==null)g=l;if(n<i||i==null)i=n;if(o>h||h==
null)h=o;if(l>k||k==null)k=l;if(n>j||j==null)j=n}this.primSets[a].points=null;this.BVL[a].min=new vec3(f,g,i);this.BVL[a].max=new vec3(h,k,j)}}};g_u_mvp=g_lineShader=g_lineFShader=g_lineVShader=null;
Mesh.prototype.initBVLDraw=function(){if(g_lineVShader==null&&g_lineFShader==null)var a=g_lineShader=createShader(gl,linesVShader,linesFShader,["point"]);for(var f=0;f<this.BVL.length;f++){var g=this.BVL[f].min,i=this.BVL[f].max;this.BVL[f].renderObj=new RenderObject(a);this.BVL[f].renderObj.world=this.world;this.BVL[f].renderObj.lineColor=new vec4(1,0,0,1);this.BVL[f].renderObj.addUniform("u_lineColor",this.BVL[f].renderObj.lineColor,UNIFORMTYPE.FLOAT4);this.BVL[f].renderObj.addUniform("u_worldMatrix",
this.world,UNIFORMTYPE.MATRIX4);this.BVL[f].renderObj.addUniform("u_viewMatrix",g_cam.view,UNIFORMTYPE.MATRIX4);this.BVL[f].renderObj.addUniform("u_projMatrix",gl.perspectiveMatrix,UNIFORMTYPE.MATRIX4);g=[g.x,g.y,g.z,i.x,g.y,g.z,i.x,g.y,g.z,i.x,i.y,g.z,i.x,i.y,g.z,g.x,i.y,g.z,g.x,i.y,g.z,g.x,g.y,g.z,g.x,g.y,i.z,i.x,g.y,i.z,i.x,g.y,i.z,i.x,i.y,i.z,i.x,i.y,i.z,g.x,i.y,i.z,g.x,i.y,i.z,g.x,g.y,i.z,g.x,g.y,g.z,g.x,g.y,i.z,i.x,g.y,g.z,i.x,g.y,i.z,i.x,i.y,g.z,i.x,i.y,i.z,g.x,i.y,g.z,g.x,i.y,i.z];this.BVL[f].renderObj.numPoints=
g.length;this.BVL[f].buffer=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,this.BVL[f].buffer);gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(g),gl.STATIC_DRAW);this.BVL[f].renderObj.addBuffers(this.BVL[f].buffer,gl.ARRAY_BUFFER,3,0,gl.FLOAT)}};Mesh.prototype.pushShaderToPrimSet=function(a,f){shaderPush([this.primSets[f]],a,this.vertexData)};Mesh.prototype.popShaderFromPrimSet=function(a){return shaderPop([this.primSets[a]])};
Mesh.prototype.pushShaderToModel=function(a){shaderPush(this.primSets,a,this.vertexData)};Mesh.prototype.popShaderFromModel=function(){return shaderPop(this.primSets)};Mesh.prototype.render=function(){if(this.loaded)for(var a=0;a<this.primSets.length;a++){var f=this.primSets[a].material;f.shader[f.shader.length-1].renderProc(this.primSets[a]);f.shader[f.shader.length-1].postRenderProc(this.primSets[a])}};
Mesh.prototype.renderOverride=function(a,f){if(this.loaded)for(var g=0;g<this.primSets.length;g++){a(this.primSets[g]);f&&f(this.primSets[g])}};Mesh.prototype.flattenMaterial=function(){for(var a=0;a<this.primSets.length;a++){var f=this.primSets[a].material;f.shader.splice(0,f.shader.length-1);f.renderObj.splice(0,f.renderObj.length-1);for(var g in f.tex)f.tex.splice(0,g.length-1)}};
Mesh.prototype.createMaterialURL=function(){this.flattenMaterial();for(var a="",f=0;f<this.primSets.length;f++){var g=this.primSets[f].material;a+="&"+f+"name="+g.name+"&"+f+"set1="+g.tex.set1[0].name+"+"+g.tex.set1[0].diff.name+"+"+g.tex.set1[0].spec.name+"+"+g.tex.set1[0].norm.name+"+"+g.tex.set1[0].layer+"+"+g.tex.set1[0].partName+"&"+f+"set2="+g.tex.set2[0].name+"+"+g.tex.set2[0].diff.name+"+"+g.tex.set2[0].spec.name+"+"+g.tex.set2[0].norm.name+"+"+g.tex.set2[0].layer+"+"+g.tex.set2[0].partName+
"&"+f+"clr="+g.fillColor[0].toURLString()+"+"+g.fillColor[1].toURLString()+"+"+g.fillColor[2].toURLString()+"&"+f+"shdr="+g.shader[0].name}return a};
Mesh.prototype.flattenMaterial=function(){for(var a=0;a<this.primSets.length;a++){var f=this.primSets[a].material;f.shader.splice(0,f.shader.length-1);f.renderObj.splice(0,f.renderObj.length-1);f.tex.diffuse1.splice(0,f.tex.diffuse1.length-1);f.tex.diffuse2.splice(0,f.tex.diffuse2.length-1);f.tex.spec1.splice(0,f.tex.spec1.length-1);f.tex.spec2.splice(0,f.tex.spec2.length-1);f.tex.normal1.splice(0,f.tex.normal1.length-1);f.tex.normal2.splice(0,f.tex.normal2.length-1);f.tex.env.splice(0,f.tex.env.length-
1);f.tex.envDiff.splice(0,f.tex.envDiff.length-1);f.tex.set1.splice(0,f.tex.set1.length-1);f.tex.set2.splice(0,f.tex.set2.length-1)}};function ScreenQuad(a){this.uvBuffer=this.vertBuffer=null;this.texture=a;this.renderObj=this.shader=null}ScreenQuad.prototype.initialize=function(a,f){a(this,f)};ScreenQuad.prototype.setTexture=function(a){this.texture=a};ScreenQuad.prototype.render=function(a){a(this)};g_activeModel=g_depthMap=theSceneRTT=mainSceneQuad=null;g_activeLayer=0;g_shadowProj=g_radialBlur=g_defaultView=g_mainLight=null;g_farZ=100;g_lightMat=g_depthShader=g_alphaTex=null;g_initComplete=false;
function preinit(){g_lightMat=[new vec4(0,0,0,0),new vec4(0,0,0,0),new vec4(0,0,0,0),new vec4(0,0,0,0)];gl=initWebGL("canvas",[0,0,0,0],g_farZ);g_depthShader=g_shaderMan.addShader("depthShader",depthMapVShader,depthMapFShader,["vert","normal","texcoord"]);gl.normalMatrix=new CanvasMatrix4;gl.mvMatrix=new CanvasMatrix4;gl.invMvMatrix=new CanvasMatrix4;gl.viewport(0,0,g_width,g_height);gl.perspectiveMatrix=new CanvasMatrix4;gl.perspectiveMatrix.perspective(45,g_width/g_height,1,g_farZ);g_mainLight=
new camera;g_mainLight.setLookAt(new vec3(-2,2,15),zeroVec(),upVec());g_mainLight.mvMatrix=new CanvasMatrix4(g_mainLight.view);g_mainLight.mvpMatrix=new CanvasMatrix4;g_mainLight.shadowMatrix=new CanvasMatrix4;g_mainLight.shadowMatrix.scale(0.6,0.6,0.5);g_mainLight.shadowMatrix.translate(0.5,0.5,0.5);startTime=(new Date).getTime();g_cam.setLookAt(new vec3(0,0,10),zeroVec(),upVec());g_defaultView=new CanvasMatrix4(g_cam.view);g_defaultTex=g_texMan.loadTexture("whiteTex.png");g_alphaTex=g_texMan.loadTexture("alphaTex.png");
g_defaultNorm1=g_texMan.loadTexture("defaultNormMap1.jpg");g_defaultNorm2=g_texMan.loadTexture("defaultNormMap2.jpg");g_cam.clearstickers();g_texMan.init();g_shaderMan.init();g_radialBlur=g_shaderMan.addShader("radialBlur",radialBlur_vshader,radialBlur_fshader);g_meshMan.loadMesh("backdropProject","content/mesh/backdrop.obj","content/mesh/backdrop.mtl","shadowProj");g_meshMan.loadMesh("backdropReceiver","content/mesh/backdrop.obj","content/mesh/backdrop.mtl","shadowReceiver");g_meshMan.loadMesh("dollbaseMale",
"content/mesh/CollectableDollBase_Maya.txt","content/mesh/CollectableDollBase_Maya.mtl","default");g_meshMan.loadMesh("dollbaseFemale","content/mesh/CollectableDollBaseF_Maya.txt","content/mesh/CollectableDollBaseF_Maya.mtl","default");g_initComplete=true;return gl}function init(){g_meshMan.addOnLoadedCallback(postMeshLoadInit);theSceneRTT=g_texMan.loadRenderTarget("mainTarget",1024,1024);mainSceneQuad=new ScreenQuad(theSceneRTT);mainSceneQuad.initialize(renderInitScreenQuad)}
function postMeshLoadInit(){g_depthMap=new RenderObject(null);g_depthMap.initialize(renderInitProcDepthMap);g_depthMap.depthRT=g_texMan.loadRenderTarget("shadowMapDepthMap",1024,1024);addModelToScene("backdropReceiver");addModelToScene("backdropProject");selectModelIntent("Skin");maybeLoadModel()&&loadModelFromURL();draw=Draw}
function resize(a){var f=document.getElementById("canvas");if(!(f.clientWidth==g_width&&f.clientHeight==g_height)){g_width=f.clientWidth;g_height=f.clientHeight;a.viewport(0,0,g_width,g_height);a.perspectiveMatrix=new CanvasMatrix4;a.perspectiveMatrix.perspective(45,g_width/g_height,1,g_farZ)}}var draw=loadingDraw;
function Draw(a){curTime=(new Date).getTime();g_dt=curTime-startTime;g_dt/=1E3;startTime=curTime;if(g_dt>0.09)g_dt=0.05;resize(a);g_cam.mouseLook(g_dt);g_meshMan.processMeshData();if(g_hiQu){a.bindFramebuffer(a.FRAMEBUFFER,g_depthMap.depthRT.frameBuffer);a.viewport(0,0,g_depthMap.depthRT.frameBuffer.width,g_depthMap.depthRT.frameBuffer.height);a.clearDepth(g_farZ);a.enable(a.DEPTH_TEST);a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT);for(objIndex in g_worldObjects)if(g_worldObjects[objIndex]!=undefined&&
g_worldObjects[objIndex].mesh.loaded==true)if(!(g_worldObjects[objIndex]!=undefined&&g_worldObjects[objIndex].name=="backdropReceiver"||g_worldObjects[objIndex]!=undefined&&g_worldObjects[objIndex].name=="backdropProject")){g_mainLight.mvpMatrix.load(g_worldObjects[objIndex].mesh.world);a.invMvMatrix.load(g_cam.world);a.invMvMatrix.invert();g_mainLight.mvpMatrix.multLeft(a.invMvMatrix);g_mainLight.mvpMatrix.multLeft(g_cam.view);g_mainLight.mvpMatrix.multLeft(a.perspectiveMatrix);g_mainLight.mvpMatrix.multLeft(g_mainLight.shadowMatrix);
g_mainLight.mvMatrix.load(g_mainLight.view);var f=new CanvasMatrix4(g_cam.view);f.multLeft(g_worldObjects[objIndex].mesh.world);f.m41=0;f.m42=0;f.m43=0;g_mainLight.mvMatrix.multLeft(f);g_mainLight.mvpMatrix.load(a.perspectiveMatrix);g_mainLight.mvpMatrix.multLeft(g_mainLight.mvMatrix);g_worldObjects[objIndex].mesh.renderOverride(renderProcDepthMap,null)}a.bindTexture(a.TEXTURE_2D,g_depthMap.depthRT);a.generateMipmap(a.TEXTURE_2D);a.bindTexture(a.TEXTURE_2D,null);a.bindFramebuffer(a.FRAMEBUFFER,null)}a.viewport(0,
0,g_width,g_height);g_hiQu&&a.bindFramebuffer(a.FRAMEBUFFER,theSceneRTT.frameBuffer);a.viewport(0,0,theSceneRTT.frameBuffer.width,theSceneRTT.frameBuffer.height);a.clearDepth(g_farZ);a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT);for(objIndex in g_worldObjects)g_worldObjects[objIndex]!=undefined&&g_worldObjects[objIndex].mesh.loaded==true&&g_worldObjects[objIndex].mesh.render();if(g_hiQu){a.bindTexture(a.TEXTURE_2D,theSceneRTT);a.generateMipmap(a.TEXTURE_2D);a.bindTexture(a.TEXTURE_2D,null);a.bindFramebuffer(a.FRAMEBUFFER,
null);a.viewport(0,0,g_width,g_height);a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT);renderProcScreenQuad(mainSceneQuad)}a.flush();framerate.snapshot()}function loadingDraw(){g_meshMan.processMeshData()}function addModelToScene(a){g_meshMan.addToScene(a)}function removeModelFromScene(a){for(var f in g_worldObjects)if(a==g_worldObjects[f].name){g_worldObjects.splice(f,1);return true}return false}function clearScene(){g_worldObjects=[]}
function maybeLoadModel(){if(urlParam("0set1"))return true;return false}function getInitComplete(){return g_initComplete};function getAvailableModels(){return g_meshMan.getModelNames()}function setModelCamera(a){g_meshMan.setModelCamera(a)}function getModelCamera(a){g_meshMan.getModelCamera(a)}function setActiveModel(a){if(g_activeModel){if(removeModelFromScene(g_activeModel)){setModelCamera(g_activeModel);g_activeModel=a;addModelToScene(a);getModelCamera(a)}}else{g_activeModel=a;addModelToScene(a);getModelCamera(a)}}
function apiSetGraphicsQuality(a){if(a=="low"){removeModelFromScene("backdropReceiver");removeModelFromScene("backdropProject");g_hiQu=false}else if(a=="high"){removeModelFromScene("backdropReceiver");removeModelFromScene("backdropProject");addModelToScene("backdropReceiver");addModelToScene("backdropProject");g_hiQu=true}}
function apiUseToolSelected(a){a=a.split(" ");if(a[0]=="undo")g_cam.undosticker();else if(a[0]=="doll1")setActiveModel("dollbaseMale");else if(a[0]=="doll2")setActiveModel("dollbaseFemale");else if(a[0]=="zoom")g_cam.zoom();else a[0]=="cameraReset"&&g_cam.reset()}function apiSetColor(a){colorFillLayer(new vec4(a.R/255,a.G/255,a.B/255,a.A/255))}function apiSelectIntent(a){g_IntentSelected=mapUIToIntentIndex(a);selectModelIntent(g_IntentText[g_IntentSelected])}
function apiPushMaterial(a){a=a.split("_");if("mat"==a[0])pushShaderToModel(a[1]);else if("sticker"==a[0]){var f="StampDecal_";if(a[1]<10)f+="0";f+=a[1]+"_DM.png";g_cam.selecttexture(g_texMan.getTextureByName(f))}else{a=parseInt(a[1]);f=g_texMan.getTextureSetNamesByLayerAndPart(getActiveLayer(),getActivePartName());pushTextureToModelPart(f[a%f.length])}}
function selectModelIntent(a){switch(a){case "None":setActiveLayer(-1);setSelectedPrimSet(-1);break;case "Skin":setActiveLayer(2);setSelectedPrimSet(0);break;case "Hair":setSelectedPrimSet(1);setActiveLayer(1);break;case "Face":setSelectedPrimSet(1);setActiveLayer(0);break;case "Body":setSelectedPrimSet(0);setActiveLayer(1);break;case "Legs":setSelectedPrimSet(0);setActiveLayer(0);break}a!="Sticker"&&g_cam.clearselection()}
function colorFillLayer(a){if(getActiveLayer()==2)return colorFillSkin(a);if(getSelectedPrimSet()==null||getSelectedPrimSet().length==0)return false;if((primSet=getSelectedPrimSet()[0])&&a&&getActiveLayer()>=0){primSet.material.fillColor[getActiveLayer()].x=a.x;primSet.material.fillColor[getActiveLayer()].y=a.y;primSet.material.fillColor[getActiveLayer()].z=a.z;primSet.material.fillColor[getActiveLayer()].w=a.w;return true}return false}
function colorFillSkin(a){if(!getActiveModel().mesh.loaded)return false;if((primSets=getActiveModel().mesh.primSets)&&a){for(var f=0;f<primSets.length;f++){primSets[f].material.fillColor[2].x=a.x;primSets[f].material.fillColor[2].y=a.y;primSets[f].material.fillColor[2].z=a.z;primSets[f].material.fillColor[2].w=a.w}return true}return false}
function setColourPickersColour(){var a=new vec4;if(getActiveLayer()==2){primSets=getActiveModel().mesh.primSets;a.x=primSets[0].material.fillColor[2].x;a.y=primSets[0].material.fillColor[2].y;a.z=primSets[0].material.fillColor[2].z;a.w=primSets[0].material.fillColor[2].w}else if((primSet=getSelectedPrimSet()[0])&&a&&getActiveLayer()>=0){a.x=primSet.material.fillColor[getActiveLayer()].x;a.y=primSet.material.fillColor[getActiveLayer()].y;a.z=primSet.material.fillColor[getActiveLayer()].y;a.w=primSet.material.fillColor[getActiveLayer()].w}}
function activateStickerPlacement(){}function pushTextureToModel(a){return texturePush(TEXTYPE.SET1,getActiveModel().mesh.primSets,a)}function popTextureFromModel(){return texturePop(TEXTYPE.SET1,getActiveModel().mesh.primSets)}function pushTextureToModelPart(a){return texturePush(TEXTYPE.SET1,getSelectedPrimSet(),a)}function popTextureFromModelPart(){return texturePop(TEXTYPE.SET1,getSelectedPrimSet())}
function pushShaderToModel(a){return shaderPush(getActiveModel().mesh.primSets,a,getActiveModel().mesh.vertexData)}function popShaderFromModel(){return shaderPop(getActiveModel().mesh.primSets)}function pushShaderToModelPart(a){return shaderPush(getSelectedPrimSet(),a,getActiveModel().mesh.vertexData)}function popShaderFromModelPart(){return shaderPop(getSelectedPrimSet())}function createModelURL(){return buildModelURL()+"&stickers="+g_cam.getstickurl()}
function loadModelFromURL(){loadMeshFromURL();loadStickersFromURL();g_cam.updateStickerCounter()};CanvasMatrix4=function(a){if(typeof a=="object")if("length"in a&&a.length>=16){this.load(a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8],a[9],a[10],a[11],a[12],a[13],a[14],a[15]);return}else if(a instanceof CanvasMatrix4){this.load(a);return}this.makeIdentity()};
CanvasMatrix4.prototype.set=function(a,f,g,i){this.m11=a.x;this.m12=a.y;this.m13=a.z;this.m14=0;this.m21=f.x;this.m22=f.y;this.m23=f.z;this.m24=0;this.m31=g.x;this.m32=g.y;this.m33=g.z;this.m34=0;this.m41=i.x;this.m42=i.y;this.m43=i.z;this.m44=1};
CanvasMatrix4.prototype.load=function(){if(arguments.length==1&&typeof arguments[0]=="object"){var a=arguments[0];if("length"in a&&a.length==16){this.m11=a[0];this.m12=a[1];this.m13=a[2];this.m14=a[3];this.m21=a[4];this.m22=a[5];this.m23=a[6];this.m24=a[7];this.m31=a[8];this.m32=a[9];this.m33=a[10];this.m34=a[11];this.m41=a[12];this.m42=a[13];this.m43=a[14];this.m44=a[15];return}if(arguments[0]instanceof CanvasMatrix4){this.m11=a.m11;this.m12=a.m12;this.m13=a.m13;this.m14=a.m14;this.m21=a.m21;this.m22=
a.m22;this.m23=a.m23;this.m24=a.m24;this.m31=a.m31;this.m32=a.m32;this.m33=a.m33;this.m34=a.m34;this.m41=a.m41;this.m42=a.m42;this.m43=a.m43;this.m44=a.m44;return}}this.makeIdentity()};CanvasMatrix4.prototype.getAsArray=function(){return[this.m11,this.m12,this.m13,this.m14,this.m21,this.m22,this.m23,this.m24,this.m31,this.m32,this.m33,this.m34,this.m41,this.m42,this.m43,this.m44]};CanvasMatrix4.prototype.getAsWebGLFloatArray=function(){return new Float32Array(this.getAsArray())};
CanvasMatrix4.prototype.makeIdentity=function(){this.m11=1;this.m21=this.m14=this.m13=this.m12=0;this.m22=1;this.m32=this.m31=this.m24=this.m23=0;this.m33=1;this.m43=this.m42=this.m41=this.m34=0;this.m44=1};CanvasMatrix4.prototype.transpose=function(){var a=this.m12;this.m12=this.m21;this.m21=a;a=this.m13;this.m13=this.m31;this.m31=a;a=this.m14;this.m14=this.m41;this.m41=a;a=this.m23;this.m23=this.m32;this.m32=a;a=this.m24;this.m24=this.m42;this.m42=a;a=this.m34;this.m34=this.m43;this.m43=a};
CanvasMatrix4.prototype.invert=function(){var a=this._determinant4x4();if(Math.abs(a)<1.0E-8)return false;this._makeAdjoint();this.m11/=a;this.m12/=a;this.m13/=a;this.m14/=a;this.m21/=a;this.m22/=a;this.m23/=a;this.m24/=a;this.m31/=a;this.m32/=a;this.m33/=a;this.m34/=a;this.m41/=a;this.m42/=a;this.m43/=a;this.m44/=a;return true};CanvasMatrix4.prototype.linearlyIndependant=function(){var a=this._determinant4x4();if(Math.abs(a)<1.0E-8)return false;return true};
CanvasMatrix4.prototype.xAxisCopy=function(){return new vec3(this.m11,this.m12,this.m13)};CanvasMatrix4.prototype.yAxisCopy=function(){return new vec3(this.m21,this.m22,this.m23)};CanvasMatrix4.prototype.zAxisCopy=function(){return new vec3(this.m31,this.m32,this.m33)};CanvasMatrix4.prototype.wAxisCopy=function(){return new vec3(this.m41,this.m42,this.m43)};CanvasMatrix4.prototype.setXAxis=function(a){this.m11=a.x;this.m12=a.y;this.m13=a.z};
CanvasMatrix4.prototype.setYAxis=function(a){this.m21=a.x;this.m22=a.y;this.m23=a.z};CanvasMatrix4.prototype.setZAxis=function(a){this.m31=a.x;this.m32=a.y;this.m33=a.z};CanvasMatrix4.prototype.setWAxis=function(a){this.m41=a.x;this.m42=a.y;this.m43=a.z};CanvasMatrix4.prototype.translate=function(a,f,g){if(a==undefined)a=0;if(f==undefined)f=0;if(g==undefined)g=0;var i=new CanvasMatrix4;i.m41=a;i.m42=f;i.m43=g;this.multRight(i)};
CanvasMatrix4.prototype.scale=function(a,f,g){if(a==undefined)a=1;if(g==undefined)if(f==undefined)g=f=a;else g=1;else if(f==undefined)f=a;var i=new CanvasMatrix4;i.m11=a;i.m22=f;i.m33=g;this.multRight(i)};
CanvasMatrix4.prototype.rotate=function(a,f,g,i){a=a/180*Math.PI;a/=2;var h=Math.sin(a);a=Math.cos(a);var k=h*h,j=Math.sqrt(f*f+g*g+i*i);if(j==0){g=f=0;i=1}else if(j!=1){f/=j;g/=j;i/=j}j=new CanvasMatrix4;if(f==1&&g==0&&i==0){j.m11=1;j.m12=0;j.m13=0;j.m21=0;j.m22=1-2*k;j.m23=2*h*a;j.m31=0;j.m32=-2*h*a;j.m33=1-2*k}else if(f==0&&g==1&&i==0){j.m11=1-2*k;j.m12=0;j.m13=-2*h*a;j.m21=0;j.m22=1;j.m23=0;j.m31=2*h*a;j.m32=0;j.m33=1-2*k}else if(f==0&&g==0&&i==1){j.m11=1-2*k;j.m12=2*h*a;j.m13=0;j.m21=-2*h*a;
j.m22=1-2*k;j.m23=0;j.m31=0;j.m32=0;j.m33=1}else{var o=f*f,l=g*g,n=i*i;j.m11=1-2*(l+n)*k;j.m12=2*(f*g*k+i*h*a);j.m13=2*(f*i*k-g*h*a);j.m21=2*(g*f*k-i*h*a);j.m22=1-2*(n+o)*k;j.m23=2*(g*i*k+f*h*a);j.m31=2*(i*f*k+g*h*a);j.m32=2*(i*g*k-f*h*a);j.m33=1-2*(o+l)*k}j.m14=j.m24=j.m34=0;j.m41=j.m42=j.m43=0;j.m44=1;this.multRight(j)};
CanvasMatrix4.prototype.makeRotationX=function(a){var f=Math.sin(a);a=Math.cos(a);this.m11=1;this.m12=this.m41=this.m31=this.m21=0;this.m22=a;this.m32=f;this.m13=this.m42=0;this.m23=-f;this.m33=a;this.m34=this.m24=this.m14=this.m43=0;this.m44=1};
CanvasMatrix4.prototype.makeRotationY=function(a){new CanvasMatrix4;var f=Math.sin(a);this.m11=a=Math.cos(a);this.m21=0;this.m31=-f;this.m12=this.m41=0;this.m22=1;this.m42=this.m32=0;this.m13=f;this.m23=0;this.m33=a;this.m34=this.m24=this.m14=this.m43=0;this.m44=1};
CanvasMatrix4.prototype.makeRotationZ=function(a){new CanvasMatrix4;var f=Math.sin(a);this.m11=a=Math.cos(a);this.m21=f;this.m41=this.m31=0;this.m12=-f;this.m22=a;this.m23=this.m13=this.m42=this.m32=0;this.m33=1;this.m34=this.m24=this.m14=this.m43=0;this.m44=1};
CanvasMatrix4.prototype.multRight=function(a){var f=this.m11*a.m12+this.m12*a.m22+this.m13*a.m32+this.m14*a.m42,g=this.m11*a.m13+this.m12*a.m23+this.m13*a.m33+this.m14*a.m43,i=this.m11*a.m14+this.m12*a.m24+this.m13*a.m34+this.m14*a.m44,h=this.m21*a.m11+this.m22*a.m21+this.m23*a.m31+this.m24*a.m41,k=this.m21*a.m12+this.m22*a.m22+this.m23*a.m32+this.m24*a.m42,j=this.m21*a.m13+this.m22*a.m23+this.m23*a.m33+this.m24*a.m43,o=this.m21*a.m14+this.m22*a.m24+this.m23*a.m34+this.m24*a.m44,l=this.m31*a.m11+
this.m32*a.m21+this.m33*a.m31+this.m34*a.m41,n=this.m31*a.m12+this.m32*a.m22+this.m33*a.m32+this.m34*a.m42,p=this.m31*a.m13+this.m32*a.m23+this.m33*a.m33+this.m34*a.m43,q=this.m31*a.m14+this.m32*a.m24+this.m33*a.m34+this.m34*a.m44,t=this.m41*a.m11+this.m42*a.m21+this.m43*a.m31+this.m44*a.m41,r=this.m41*a.m12+this.m42*a.m22+this.m43*a.m32+this.m44*a.m42,u=this.m41*a.m13+this.m42*a.m23+this.m43*a.m33+this.m44*a.m43,s=this.m41*a.m14+this.m42*a.m24+this.m43*a.m34+this.m44*a.m44;this.m11=this.m11*a.m11+
this.m12*a.m21+this.m13*a.m31+this.m14*a.m41;this.m12=f;this.m13=g;this.m14=i;this.m21=h;this.m22=k;this.m23=j;this.m24=o;this.m31=l;this.m32=n;this.m33=p;this.m34=q;this.m41=t;this.m42=r;this.m43=u;this.m44=s};
CanvasMatrix4.prototype.multLeft=function(a){var f=a.m11*this.m12+a.m12*this.m22+a.m13*this.m32+a.m14*this.m42,g=a.m11*this.m13+a.m12*this.m23+a.m13*this.m33+a.m14*this.m43,i=a.m11*this.m14+a.m12*this.m24+a.m13*this.m34+a.m14*this.m44,h=a.m21*this.m11+a.m22*this.m21+a.m23*this.m31+a.m24*this.m41,k=a.m21*this.m12+a.m22*this.m22+a.m23*this.m32+a.m24*this.m42,j=a.m21*this.m13+a.m22*this.m23+a.m23*this.m33+a.m24*this.m43,o=a.m21*this.m14+a.m22*this.m24+a.m23*this.m34+a.m24*this.m44,l=a.m31*this.m11+a.m32*
this.m21+a.m33*this.m31+a.m34*this.m41,n=a.m31*this.m12+a.m32*this.m22+a.m33*this.m32+a.m34*this.m42,p=a.m31*this.m13+a.m32*this.m23+a.m33*this.m33+a.m34*this.m43,q=a.m31*this.m14+a.m32*this.m24+a.m33*this.m34+a.m34*this.m44,t=a.m41*this.m11+a.m42*this.m21+a.m43*this.m31+a.m44*this.m41,r=a.m41*this.m12+a.m42*this.m22+a.m43*this.m32+a.m44*this.m42,u=a.m41*this.m13+a.m42*this.m23+a.m43*this.m33+a.m44*this.m43,s=a.m41*this.m14+a.m42*this.m24+a.m43*this.m34+a.m44*this.m44;this.m11=a.m11*this.m11+a.m12*
this.m21+a.m13*this.m31+a.m14*this.m41;this.m12=f;this.m13=g;this.m14=i;this.m21=h;this.m22=k;this.m23=j;this.m24=o;this.m31=l;this.m32=n;this.m33=p;this.m34=q;this.m41=t;this.m42=r;this.m43=u;this.m44=s};CanvasMatrix4.prototype.ortho=function(a,f,g,i,h,k){var j=(a+f)/(a-f),o=(i+g)/(i-g),l=(k+h)/(k-h),n=new CanvasMatrix4;n.m11=2/(a-f);n.m12=0;n.m13=0;n.m14=0;n.m21=0;n.m22=2/(i-g);n.m23=0;n.m24=0;n.m31=0;n.m32=0;n.m33=-2/(k-h);n.m34=0;n.m41=j;n.m42=o;n.m43=l;n.m44=1;this.multRight(n)};
CanvasMatrix4.prototype.frustum=function(a,f,g,i,h,k){var j=new CanvasMatrix4,o=(f+a)/(f-a),l=(i+g)/(i-g),n=-(k+h)/(k-h);k=-(2*k*h)/(k-h);j.m11=2*h/(f-a);j.m12=0;j.m13=0;j.m14=0;j.m21=0;j.m22=2*h/(i-g);j.m23=0;j.m24=0;j.m31=o;j.m32=l;j.m33=n;j.m34=-1;j.m41=0;j.m42=0;j.m43=k;j.m44=0;this.multRight(j)};CanvasMatrix4.prototype.perspective=function(a,f,g,i){a=Math.tan(a*Math.PI/360)*g;var h=-a;this.frustum(f*h,f*a,h,a,g,i)};
CanvasMatrix4.prototype.veclookat=function(a,f,g){this.lookat(a.x,a.y,a.z,f.x,f.y,f.z,g.x,g.y,g.z)};
CanvasMatrix4.prototype.lookat=function(a,f,g,i,h,k,j,o,l){var n=new CanvasMatrix4;i=a-i;h=f-h;k=g-k;var p=Math.sqrt(i*i+h*h+k*k);if(p){i/=p;h/=p;k/=p}j=j;o=o;l=l;xx=o*k-l*h;xy=-j*k+l*i;xz=j*h-o*i;o=-i*xz+k*xx;j=i*xy-h*xx;if(p=Math.sqrt(xx*xx+xy*xy+xz*xz)){xx/=p;xy/=p;xz/=p}if(p=Math.sqrt(j*j+o*o+l*l)){j/=p;o/=p;l/=p}n.m11=xx;n.m12=xy;n.m13=xz;n.m14=0;n.m21=j;n.m22=o;n.m23=l;n.m24=0;n.m31=i;n.m32=h;n.m33=k;n.m34=0;n.m41=0;n.m42=0;n.m43=0;n.m44=1;n.translate(-a,-f,-g);this.multRight(n)};
CanvasMatrix4.prototype._determinant2x2=function(a,f,g,i){return a*i-f*g};CanvasMatrix4.prototype._determinant3x3=function(a,f,g,i,h,k,j,o,l){return a*this._determinant2x2(h,k,o,l)-i*this._determinant2x2(f,g,o,l)+j*this._determinant2x2(f,g,h,k)};
CanvasMatrix4.prototype._determinant4x4=function(){var a=this.m12,f=this.m13,g=this.m14,i=this.m21,h=this.m22,k=this.m23,j=this.m24,o=this.m31,l=this.m32,n=this.m33,p=this.m34,q=this.m41,t=this.m42,r=this.m43,u=this.m44;return this.m11*this._determinant3x3(h,l,t,k,n,r,j,p,u)-a*this._determinant3x3(i,o,q,k,n,r,j,p,u)+f*this._determinant3x3(i,o,q,h,l,t,j,p,u)-g*this._determinant3x3(i,o,q,h,l,t,k,n,r)};
CanvasMatrix4.prototype._makeAdjoint=function(){var a=this.m11,f=this.m12,g=this.m13,i=this.m14,h=this.m21,k=this.m22,j=this.m23,o=this.m24,l=this.m31,n=this.m32,p=this.m33,q=this.m34,t=this.m41,r=this.m42,u=this.m43,s=this.m44;this.m11=this._determinant3x3(k,n,r,j,p,u,o,q,s);this.m21=-this._determinant3x3(h,l,t,j,p,u,o,q,s);this.m31=this._determinant3x3(h,l,t,k,n,r,o,q,s);this.m41=-this._determinant3x3(h,l,t,k,n,r,j,p,u);this.m12=-this._determinant3x3(f,n,r,g,p,u,i,q,s);this.m22=this._determinant3x3(a,
l,t,g,p,u,i,q,s);this.m32=-this._determinant3x3(a,l,t,f,n,r,i,q,s);this.m42=this._determinant3x3(a,l,t,f,n,r,g,p,u);this.m13=this._determinant3x3(f,k,r,g,j,u,i,o,s);this.m23=-this._determinant3x3(a,h,t,g,j,u,i,o,s);this.m33=this._determinant3x3(a,h,t,f,k,r,i,o,s);this.m43=-this._determinant3x3(a,h,t,f,k,r,g,j,u);this.m14=-this._determinant3x3(f,k,n,g,j,p,i,o,q);this.m24=this._determinant3x3(a,h,l,g,j,p,i,o,q);this.m34=-this._determinant3x3(a,h,l,f,k,n,i,o,q);this.m44=this._determinant3x3(a,h,l,f,
k,n,g,j,p)};CanvasMatrix4.prototype.vectorMultLeft=function(a){out=new vec4(0,0,0,0);out.x=a.x*this.m11+a.y*this.m21+a.z*this.m31+a.w*this.m41;out.y=a.x*this.m12+a.y*this.m22+a.z*this.m32+a.w*this.m42;out.z=a.x*this.m13+a.y*this.m23+a.z*this.m33+a.w*this.m43;out.w=a.x*this.m14+a.y*this.m24+a.z*this.m34+a.w*this.m44;return out};
CanvasMatrix4.prototype.vectorMultRight=function(a){out=new vec4(0,0,0,0);out.x=a.x*this.m11+a.y*this.m12+a.z*this.m13+a.w*this.m14;out.y=a.x*this.m21+a.y*this.m22+a.z*this.m23+a.w*this.m24;out.z=a.x*this.m31+a.y*this.m32+a.z*this.m33+a.w*this.m34;out.w=a.x*this.m41+a.y*this.m42+a.z*this.m43+a.w*this.m44;return out};
function createRotationX(a){var f=new CanvasMatrix4,g=Math.sin(a);a=Math.cos(a);f.m11=1;f.m21=0;f.m31=0;f.m41=0;f.m12=0;f.m22=a;f.m32=g;f.m42=0;f.m13=0;f.m23=-g;f.m33=a;f.m43=0;f.m14=0;f.m24=0;f.m34=0;f.m44=1;return f}function createRotationY(a){var f=new CanvasMatrix4,g=Math.sin(a);a=Math.cos(a);f.m11=a;f.m21=0;f.m31=-g;f.m41=0;f.m12=0;f.m22=1;f.m32=0;f.m42=0;f.m13=g;f.m23=0;f.m33=a;f.m43=0;f.m14=0;f.m24=0;f.m34=0;f.m44=1;return f}
function createRotationZ(a){var f=new CanvasMatrix4,g=Math.sin(a);a=Math.cos(a);f.m11=a;f.m21=g;f.m31=0;f.m41=0;f.m12=-g;f.m22=a;f.m32=0;f.m42=0;f.m13=0;f.m23=0;f.m33=1;f.m43=0;f.m14=0;f.m24=0;f.m34=0;f.m44=1;return f};function makeBox(a){var f=new Float32Array([1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,-1]),g=new Float32Array([0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1]),i=new Float32Array([1,1,0,1,0,0,1,0,0,1,0,0,1,0,1,1,1,0,1,1,0,1,0,0,1,1,0,1,0,0,1,0,0,0,1,0,1,1,0,
1,0,0,1,0,1,1,0,1]),h=new Uint8Array([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]),k={};k.normalObject=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,k.normalObject);a.bufferData(a.ARRAY_BUFFER,g,a.STATIC_DRAW);k.texCoordObject=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,k.texCoordObject);a.bufferData(a.ARRAY_BUFFER,i,a.STATIC_DRAW);k.vertexObject=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,k.vertexObject);a.bufferData(a.ARRAY_BUFFER,f,a.STATIC_DRAW);
a.bindBuffer(a.ARRAY_BUFFER,null);k.indexObject=a.createBuffer();a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,k.indexObject);a.bufferData(a.ELEMENT_ARRAY_BUFFER,h,a.STATIC_DRAW);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null);k.numIndices=h.length;return k}
function makeSphere(a,f,g,i){for(var h=[],k=[],j=[],o=[],l=0;l<=g;++l)for(var n=0;n<=i;++n){var p=l*Math.PI/g,q=n*2*Math.PI/i,t=Math.sin(p),r=Math.sin(q);p=Math.cos(p);q=Math.cos(q)*t;p=p;t=r*t;r=1-n/i;var u=l/g;k.push(q);k.push(p);k.push(t);j.push(r);j.push(u);h.push(f*q);h.push(f*p);h.push(f*t)}for(l=0;l<g;++l)for(n=0;n<i;++n){f=l*(i+1)+n;q=f+i+1;o.push(f);o.push(q);o.push(f+1);o.push(q);o.push(q+1);o.push(f+1)}g={};g.normalObject=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,g.normalObject);a.bufferData(a.ARRAY_BUFFER,
new Float32Array(k),a.STATIC_DRAW);g.texCoordObject=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,g.texCoordObject);a.bufferData(a.ARRAY_BUFFER,new Float32Array(j),a.STATIC_DRAW);g.vertexObject=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,g.vertexObject);a.bufferData(a.ARRAY_BUFFER,new Float32Array(h),a.STATIC_DRAW);g.numIndices=o.length;g.indexObject=a.createBuffer();a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,g.indexObject);a.bufferData(a.ELEMENT_ARRAY_BUFFER,new Uint16Array(o),a.STREAM_DRAW);return g}
function loadImageTexture(a,f){var g=a.createTexture();g.image=new Image;g.image.onload=function(){doLoadImageTexture(a,g.image,g)};g.image.src=f;return g}
function doLoadImageTexture(a,f,g){a.bindTexture(a.TEXTURE_2D,g);a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,true);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,f);if(a.getError()==0){a.generateMipmap(a.TEXTURE_2D);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR_MIPMAP_LINEAR);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE)}a.bindTexture(a.TEXTURE_2D,
null)}Framerate=function(a){this.numFramerates=10;this.framerateUpdateInterval=500;this.id=a;this.renderTime=-1;this.framerates=[];self=this};Framerate.prototype.updateFramerate=function(){for(var a=0,f=0;f<this.framerates.length;++f)a+=this.framerates[f];a=a/this.framerates.length;a=Math.round(a);document.getElementById(this.id).innerHTML="<h4>FPS: "+a+"</h4>"};
Framerate.prototype.snapshot=function(){if(this.renderTime<0)this.renderTime=(new Date).getTime();else{var a=(new Date).getTime();for(this.framerates.push(1E3/(a-this.renderTime));this.framerates.length>this.numFramerates;)this.framerates.shift();this.renderTime=a}};function vec3(a,f,g){this.x=a;this.y=f;this.z=g}vec3.prototype.scale=function(a){this.x*=a;this.y*=a;this.z*=a};vec3.prototype.getAsArray=function(){return[this.x,this.y,this.z]};vec3.prototype.getAsWebGLFloatArray=function(){return new Float32Array(this.getAsArray())};vec3.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)};vec3.prototype.lengthSqrd=function(){return dotVec3(this,this)};
vec3.prototype.normalize=function(){length=this.length();if(length==0){this.y=this.x=0;this.z=1}else if(length!=1){this.x/=length;this.y/=length;this.z/=length}};vec3.prototype.normalized=function(){length=this.length();var a=new vec3(0,0,0);if(length==0)a=lookVec();else{a.x=this.x/length;a.y=this.y/length;a.z=this.z/length}return a};vec3.prototype.negate=function(){this.x=-1*this.x;this.y=-1*this.y;this.z=-1*this.z};vec3.prototype.setvec=function(a){this.x=a.x;this.y=a.y;this.z=a.z};
vec3.prototype.toString=function(){return"("+this.x+","+this.y+","+this.z+")"};function addVec3(a,f){return new vec3(a.x+f.x,a.y+f.y,a.z+f.z)}function subVec3(a,f){return new vec3(a.x-f.x,a.y-f.y,a.z-f.z)}function dotVec3(a,f){return a.x*f.x+a.y*f.y+a.z*f.z}function crossVec3(a,f){return new vec3(a.y*f.z-f.y*a.z,-(a.x*f.z-f.x*a.z),a.x*f.y-f.x*a.y)}function lerpVec3(a,f,g){f=subVec3(f,a);f.scale(g);return addVec3(a,f)}
function negateVec3(a){var f=new vec3(a.x,a.y,a.z);f.x=-1*a.x;f.y=-1*a.y;f.z=-1*a.z;return f}function scaleVec3(a,f){var g=new vec3(a.x,a.y,a.z);g.x*=f;g.y*=f;g.z*=f;return g}function zeroVec(){return new vec3(0,0,0)}function rightVec(){return new vec3(1,0,0)}function upVec(){return new vec3(0,1,0)}function lookVec(){return new vec3(0,0,1)};function vec2(a,f){this.x=a;this.y=f}vec2.prototype.scale=function(a){this.x*=a;this.y*=a};vec2.prototype.lerp=function(a,f,g){b=subVec2(vecB,a);b.scale(g);return add(a,b)};vec2.prototype.addVec2=function(a,f){return new Vector2(a.x+f.x,a.y+f.y)};vec2.prototype.subVec2=function(a,f){return new Vector2(a.x-f.x,a.y-f.y)};vec2.prototype.zeroVec2=function(){return new vec2(0,0)};vec2.prototype.rightVec2=function(){return new vec2(1,0)};vec2.prototype.upVec2=function(){return new vec2(0,1)};function vec4(a,f,g,i){this.x=a;this.y=f;this.z=g;this.w=i}vec4.prototype.getAsArray=function(){return[this.x,this.y,this.z,this.w]};vec4.prototype.getAsWebGLFloatArray=function(){return new Float32Array(this.getAsArray())};vec4.prototype.toString=function(){return"("+this.x+", "+this.y+", "+this.z+", "+this.w+")"};vec4.prototype.toURLString=function(){var a=(this.x*10).toFixed(2),f=(this.y*10).toFixed(2),g=(this.z*10).toFixed(2),i=(this.w*10).toFixed(2);return a+","+f+","+g+","+i};
vec4.prototype.setvec=function(a){this.x=a.x;this.y=a.y;this.z=a.z;this.w=a.w};function camera(){this.view=new CanvasMatrix4;this.world=new CanvasMatrix4;this.oldWorld=new CanvasMatrix4;this.orbitMatrix=new CanvasMatrix4;this.position=new vec3(0,0,0);this.look=new vec3(0,0,0);this.sticker=new CanvasMatrix4;this.orbiting=this.zoomed=false;this.orbitingVec=new vec2(0,0);this.inertialVec=new vec2(0,0);this.stickers=[];this.stickersPos=[];this.stickersLookAt=[];this.stickerTexture=[];this.partZoom=1;this.clearstickers()}
camera.prototype.reset=function(){this.view=new CanvasMatrix4;this.world=new CanvasMatrix4;this.oldWorld=new CanvasMatrix4;this.orbitMatrix=new CanvasMatrix4;this.position=new vec3(0,0,0);this.look=new vec3(0,0,0);this.orbiting=this.zoomed=false;this.setLookAt(new vec3(0,0,10),zeroVec(),upVec())};
camera.prototype.clearstickers=function(){for(var a=0;a<9;a++){this.stickers[a]=new CanvasMatrix4;this.stickersPos[a]=new vec3(0,0,0);this.stickersLookAt[a]=new vec3(0,0,0);this.stickerTexture[a]=g_alphaTex}this.currentSticker=0};
camera.prototype.copy=function(a){this.view.load(a.view);this.world.load(a.world);this.oldWorld.load(a.oldWorld);this.orbitMatrix.load(a.orbitMatrix);this.position.setvec(a.position);this.look.setvec(a.look);this.sticker.load(a.sticker);this.zoomed=a.zoomed;for(var f=0;f<9;f++){this.stickers[f].load(a.stickers[f]);this.stickers[f].curScale=1;this.stickersPos[f].setvec(a.stickersPos[f]);this.stickersLookAt[f].setvec(a.stickersPos[f]);this.stickerTexture[f]=a.stickerTexture[f]}this.currentSticker=a.currentSticker;
this.orbiting=false;this.partZoom=a.partZoom;this.updateStickerCounter()};
camera.prototype.updateView=function(){this.position.x=this.world.m41;this.position.y=this.world.m42;this.position.z=this.world.m43;this.look.x=this.world.m31;this.look.y=this.world.m32;this.look.z=this.world.m33;tempM=new CanvasMatrix4(this.world);tempM.m31*=-1;tempM.m32*=-1;tempM.m33*=-1;tempM.m11*=-1;tempM.m12*=-1;tempM.m13*=-1;this.view.load(tempM);this.view.m41=0;this.view.m42=0;this.view.m43=0;this.view.transpose();this.view.m41=-dotVec3(new vec3(tempM.m11,tempM.m12,tempM.m13),new vec3(tempM.m41,
tempM.m42,tempM.m43));this.view.m42=-dotVec3(new vec3(tempM.m21,tempM.m22,tempM.m23),new vec3(tempM.m41,tempM.m42,tempM.m43));this.view.m43=-dotVec3(new vec3(tempM.m31,tempM.m32,tempM.m33),new vec3(tempM.m41,tempM.m42,tempM.m43))};camera.prototype.setLookAt=function(a,f,g){a=new vec3(a.x,a.y,a.z);f=subVec3(f,a);f.normalize();g=crossVec3(g,f);g.normalize();var i=crossVec3(f,g);i.normalize();this.world.set(g,i,f,a);this.updateView()};
camera.prototype.pitch=function(a){this.world.multLeft(createRotationX(a));this.updateView()};camera.prototype.yaw=function(a){this.world.multLeft(createRotationY(a));this.updateView()};camera.prototype.roll=function(a){this.world.multLeft(createRotationZ(a));this.updateView()};camera.prototype.translateOnZ=function(a){a=scaleVec3(this.world.zAxisCopy(),a);this.world.translate(a.x,a.y,a.z);this.updateView()};
camera.prototype.translateOnX=function(a){a=scaleVec3(this.world.xAxisCopy(),a);this.world.translate(a.x,a.y,a.z);this.updateView()};camera.prototype.translateOnY=function(a){a=scaleVec3(this.world.yAxisCopy(),a);this.world.translate(a.x,a.y,a.z);this.updateView()};
camera.prototype.zoom=function(){if(this.zoomed||g_collMan.BV.length)if(this.zoomed=!this.zoomed){boxMin=g_collMan.BV[0].min;boxMax=g_collMan.BV[0].max;boxCenter=addVec3(boxMin,boxMax);boxCenter.scale(0.5);bW=Math.abs(boxMax.x-boxMin.x);bH=Math.abs(boxMax.y-boxMin.y);bD=Math.abs(boxMax.z-boxMin.z);radius=bW>bH?bW>bD?bW:bD:bH>bD?bH:bD;curPos=this.world.wAxisCopy();zoomVec=subVec3(boxCenter,curPos);zoomVec.normalize();zoomVec.scale(radius*2);targetPos=subVec3(boxCenter,zoomVec);this.oldWorld.load(this.world);
this.setLookAt(targetPos,boxCenter,this.world.yAxisCopy());this.partZoom=radius*2/10}else{this.world.load(this.oldWorld);this.updateView();this.partZoom=1}};
camera.prototype.mouseLook=function(){mousePos=getCursorPos();mouseDiff=new vec2(0,0);if(lastMousePos.x==mousePos.x&&lastMousePos.y==mousePos.y){if(this.orbiting){this.inertialVec.x=mousePos.x-this.inertialVec.x;this.inertialVec.y=mousePos.y-this.inertialVec.y}this.orbiting=false;this.inertialVec.x*=0.8;this.inertialVec.y*=0.8;mouseDiff.x=this.inertialVec.x;mouseDiff.y=this.inertialVec.y;this.orbitMatrix.load(this.world)}else{if(!this.orbiting){this.orbiting=true;this.orbitingVec.x=mousePos.x;this.orbitingVec.y=
mousePos.y;this.orbitMatrix.load(this.world)}mouseDiff=new vec2(mousePos.x-this.orbitingVec.x,mousePos.y-this.orbitingVec.y);this.inertialVec.x=mousePos.x;this.inertialVec.y=mousePos.y}var a=512,f=document.getElementById("canvas");if(f)a=f.width;mouseDiff.scale(3.142/180);mouseDiff.scale(180/a);mouseDiffDisplay=new vec2(mouseDiff.x*180,mouseDiff.y*180);this.world.load(this.orbitMatrix);a=this.world.yAxisCopy();f=this.world.xAxisCopy();this.world.rotate(mouseDiff.y*180/3.142,f.x,f.y,f.z);this.world.rotate(-mouseDiff.x*
180/3.142,a.x,a.y,a.z);this.world.setXAxis(this.world.xAxisCopy().normalized());this.world.setYAxis(this.world.yAxisCopy().normalized());this.world.setZAxis(this.world.zAxisCopy().normalized());this.updateView();stickerPos=getStickerPos();a=1/getStickerZoom()*2;f=new vec3;var g=new CanvasMatrix4;g.load(this.view);g.multLeft(gl.perspectiveMatrix);f.setvec(g.vectorMultLeft(new vec4(1.8,0,0,0)));f=f.length();f=new vec4(-stickerPos.x*f,-stickerPos.y*f,0,0);f.x+=0.5/a;f.y-=0.5/a;g=this.world.vectorMultLeft(f);
if(this.partZoom!=1){f.y+=(this.world.m42-this.oldWorld.m42)*this.partZoom;f.x+=(this.world.m41-this.oldWorld.m41)*this.partZoom}this.stickersPos[this.currentSticker].setvec(this.world.wAxisCopy());this.stickersLookAt[this.currentSticker].setvec(g);this.buildstickermatrix();this.sticker.scale(a);this.stickers[this.currentSticker].load(this.sticker);this.stickers[this.currentSticker].curScale=a};
camera.prototype.nextSticker=function(){if(this.currentSticker<8&&this.stickerTexture[this.currentSticker]!=g_alphaTex){this.stickerTexture[this.currentSticker+1]=this.stickerTexture[this.currentSticker];this.currentSticker++;zoomDirty=true}this.updateStickerCounter()};camera.prototype.updateStickerCounter=function(){var a;a=this.currentSticker==8?"<b>FULL</b>":this.currentSticker+"/8";jQuery("numSticker#stickerCounter").html(a)};
camera.prototype.undosticker=function(){this.stickerTexture[this.currentSticker]=g_alphaTex;this.currentSticker>0&&this.currentSticker--;jQuery("numSticker#stickerCounter").html(this.currentSticker+"/8")};camera.prototype.selecttexture=function(a){this.stickerTexture[this.currentSticker]=a};camera.prototype.selecttextureindex=function(a){var f="StampDecal_";if(arr[1]<10)f+="0";f+=a+"_DM.png";this.selecttexture(g_texMan.getTextureByName(f))};
camera.prototype.clearselection=function(){this.stickerTexture[this.currentSticker]=g_alphaTex};camera.prototype.buildstickermatrix=function(){var a=new CanvasMatrix4,f=new CanvasMatrix4;a.load(this.world);f.load(this.view);this.setLookAt(this.stickersPos[this.currentSticker],this.stickersLookAt[this.currentSticker],this.world.yAxisCopy());this.sticker.load(this.view);this.world.load(a);this.view.load(f)};
camera.prototype.setstickurl=function(a){a=a.split(",");var f=a[0];this.currentSticker=0;for(var g=1,i=0;i<f;i++){this.selecttexture(g_texMan.getTextureByName(a[g++]));this.stickersPos[this.currentSticker].x=a[g++]/100;this.stickersPos[this.currentSticker].y=a[g++]/100;this.stickersPos[this.currentSticker].z=a[g++]/100;var h=a[g++]/100;this.stickersLookAt[this.currentSticker].x=a[g++]/100;this.stickersLookAt[this.currentSticker].y=a[g++]/100;this.stickersLookAt[this.currentSticker].z=a[g++]/100;this.buildstickermatrix();
this.sticker.scale(h);this.stickers[this.currentSticker].load(this.sticker);this.stickers[this.currentSticker].curScale=h;this.currentSticker++}};
camera.prototype.getstickurl=function(){var a=new String;a+=this.currentSticker;for(var f=0;f<this.currentSticker;f++){a+=","+this.stickerTexture[f].name;a+=","+(this.stickersPos[f].x*100).toFixed();a+=","+(this.stickersPos[f].y*100).toFixed();a+=","+(this.stickersPos[f].z*100).toFixed();a+=","+(this.stickers[f].curScale*100).toFixed();a+=","+(this.stickersLookAt[f].x*100).toFixed();a+=","+(this.stickersLookAt[f].y*100).toFixed();a+=","+(this.stickersLookAt[f].z*100).toFixed()}return a};function setRandTimer(a){return setInterval(a+"()",randTimer())}function randTimer(){return Math.random()*4E3+1E3}function getRandColor(){return new vec4(Math.random(),Math.random(),Math.random(),1)}var lastTex=0;function getNextTexture(a){texTable=a!=undefined?g_texMan.getTextureSetNamesByLayerAndPart(a,getActivePartName()):g_texMan.getTextureSetNames();a=lastTex++%texTable.length;return texTable[a]}var lastShader=0;
function getNextShader(){shaderTable=g_shaderMan.getShaderNames();var a=lastShader++%shaderTable.length;return shaderTable[a]}function unProject(a,f,g,i,h,k){i=new CanvasMatrix4(i);var j=[0,0,0,0];i.multRight(h);if(!i.invert())return null;j[0]=a;j[1]=f;j[2]=g;j[3]=1;j[0]=(j[0]-k[0])/k[2];j[1]=(j[1]-k[1])/k[3];j[0]=j[0]*2-1;j[1]=j[1]*2-1;j[2]=j[2]*2-1;a=i.vectorMultLeft(new vec4(j[0],j[1],j[2],j[3]));if(a.w==0)return null;a.x/=a.w;a.y/=a.w;a.z/=a.w;return new vec3(a.x,a.y,a.z)}
function AABB2LineSegment(a,f,g){c=addVec3(a.min,a.max);c.scale(0.5);e=subVec3(a.max,a.min);d=subVec3(g,f);m=addVec3(f,g);m=subVec3(m,a.min);m=subVec3(m,a.max);a=Math.abs(d.x);if(Math.abs(m.x)>e.x+a)return false;f=Math.abs(d.y);if(Math.abs(m.y)>e.y+f)return false;g=Math.abs(d.z);if(Math.abs(m.z)>e.z+g)return false;a+=1.192092896E-7;f+=1.192092896E-7;g+=1.192092896E-7;if(Math.abs(m.y*d.z-m.z*d.y)>e.y*g+e.z*f)return false;if(Math.abs(m.z*d.x-m.x*d.z)>e.x*g+e.z*a)return false;if(Math.abs(m.x*d.y-m.y*
d.x)>e.x*f+e.y*a)return false;debug=0;debug++;return true}gLineBuffer=null;function updateDrawLine(a,f){if(g_lineShader){gLineBuffer&&gl.deleteBuffer(gLineBuffer);verts=[a.x,a.y,a.z,f.x,f.y,f.z];gLineBuffer=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,gLineBuffer);gl.bufferData(gl.ARRAY_BUFFER,new WebGLFloatArray(verts),gl.STATIC_DRAW)}}
function drawLine(a){if(g_lineShader&&g_u_mvp&&gLineBuffer){gl.useProgram(g_lineShader);gl.uniformMatrix4fv(g_u_mvp,false,a.getAsWebGLFloatArray());gl.bindBuffer(gl.ARRAY_BUFFER,gLineBuffer);gl.vertexAttribPointer(0,3,gl.FLOAT,false,0,0);gl.enableVertexAttribArray(0);gl.drawArrays(gl.LINES,0,2);gl.useProgram(null)}}
function hitTest(a,f,g){for(var i=null,h=null,k=0;k<a.BVL.length;k++)if(AABB2LineSegment(a.BVL[k],f,g)){var j=addVec3(a.BVL[k].min,a.BVL[k].max);j.scale(0.5);j=dotVec3(g_cam.world.zAxisCopy(),j);if(j<i||i==null){i=j;h=a.BVL[k]}}return h}function drawBVLColor(a,f,g,i,h){renderProcLines(a.renderObj,f,g,i,h)}function drawBVL(a){renderProcLines(a.renderObj,1,0,0,1)}
function getScreenAlignedQuad(){var a=new Float32Array([-1,1,0,1,1,0,-1,-1,0,-1,-1,0,1,1,0,1,-1,0]),f=new Float32Array([0,0,0,1,1,1,1,1,1,0,0,0]),g={};g.vertexObject=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,g.vertexObject);gl.bufferData(gl.ARRAY_BUFFER,a,gl.STATIC_DRAW);g.texCoordObject=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,g.texCoordObject);gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(f),gl.STATIC_DRAW);return g}
function initWebGL(a,f,g){a=document.getElementById(a);var i;try{(i=a.getContext("experimental-webgl",true,true,false,true,true))||(i=a.getContext("webgl",true,true,false,true,true));i||(i=a.getContext("webkit-3d",true,true,false,true,true));i||(i=a.getContext("moz-webgl",true,true,false,true,true))}catch(h){}if(!i){jQuery("#webGLerror").removeClass("hide");return null}i=i;i.console="console"in window?window.console:{log:function(){}};i.clearColor(f[0],f[1],f[2],f[3]);i.clearDepth(g);i.depthFunc(i.LESS);
i.enable(i.DEPTH_TEST);return i}function loadShader(a,f,g){f=a.createShader(f);if(f==null)return null;a.shaderSource(f,g);a.compileShader(f);if(!a.getShaderParameter(f,a.COMPILE_STATUS)){a.getShaderInfoLog(f);a.deleteShader(f);return null}return f}
function createShader(a,f,g,i){gl.useProgram(null);f=loadShader(a,gl.VERTEX_SHADER,f);g=loadShader(a,gl.FRAGMENT_SHADER,g);if(!f||!g)return null;var h=a.createProgram();if(!h)return null;a.attachShader(h,f);a.attachShader(h,g);for(var k in i)a.bindAttribLocation(h,k,i[k]);a.linkProgram(h);if(!a.getProgramParameter(h,a.LINK_STATUS)){a.getProgramInfoLog(h);a.deleteProgram(h);a.deleteProgram(g);a.deleteProgram(f);return null}return h}
function getSelectedPrimSet(){if(g_collMan.BV.length)return[g_collMan.BV[0].primSetRef];return null}function setSelectedPrimSet(a){model=getActiveModel();if(model!=null){g_collMan.BV=[];if(!(a<0)){if(a>model.mesh.primSets.length)a=model.mesh.primSets.length-1;g_collMan.BV.push(model.mesh.BVL[a])}}}function setActiveLayer(a){g_activeLayer=a}function getActiveLayer(){return g_activeLayer}
function getActivePartName(){switch(g_IntentText[g_IntentSelected]){case "Hair":return"Head";case "Face":return"Head";case "Body":return"Body";case "Legs":return"Body";default:gl.console.log("ERROR: cannot determine the active part")}}
function getTexSlotByPartName(){switch(g_IntentText[g_IntentSelected]){case "Hair":return TEXTYPE.SET2;case "Face":return TEXTYPE.SET1;case "Body":return TEXTYPE.SET2;case "Legs":return TEXTYPE.SET1;default:gl.console.log("ERROR: cannot determine the active part")}}function setActivePartName(){return g_IntentText[g_IntentSelected]}function arrayPeek(a){return a[a.length-1]}TEXTYPE=new __texType;
function __texType(){this.DIF1=0;this.DIF2=1;this.SPEC1=2;this.SPEC2=3;this.NORM1=4;this.NORM2=5;this.ENV=6;this.ENVDIFF=7;this.SET1=8;this.SET2=9;this.MAX=10}
function getTexStack(a,f){switch(a){case TEXTYPE.DIF1:return f.material.tex.diffuse1;case TEXTYPE.DIF2:return f.material.tex.diffuse2;case TEXTYPE.SPEC1:return f.material.tex.spec1;case TEXTYPE.SPEC2:return f.material.tex.spec2;case TEXTYPE.NORM1:return f.material.tex.normal1;case TEXTYPE.NORM2:return f.material.tex.normal2;case TEXTYPE.ENV:return f.material.tex.env;case TEXTYPE.ENVDIFF:return f.material.tex.envDiff;case TEXTYPE.SET1:return f.material.tex.set1;case TEXTYPE.SET2:return f.material.tex.set2;
default:gl.console.log("ERROR: Unknown texture type used when trying to request a texture stack");return null}}function getActiveModel(){if(g_activeModel)return g_meshMan.getModelByName(g_activeModel);return null}function texturePop(a,f){if(f==undefined||f==null)return false;for(var g in f){var i=getTexStack(a,f[g]);if(i)i.length>1&&i.pop();else return false}return true}
function texturePush(a,f,g){a=getTexSlotByPartName();if(f==undefined||f==null)return false;g=g_texMan.getTextureSetByName(g);if(g==null)return false;for(var i in f){var h=getTexStack(a,f[i]);if(h)h.push(g);else return false}return true}function shaderPop(a){if(a==undefined||a==null)return false;for(var f in a)if(a[f].material.shader.length>1){arrayPeek(a[f].material.shader).envMap&&a[f].material.tex.env.pop();a[f].material.shader.pop();a[f].material.renderObj.pop()}return true}
function shaderPush(a,f,g){if(a==undefined||a==null)return false;var i=g_shaderMan.getShaderByName(f);if(f==null)return false;for(var h in a){a[h].material.renderObj.push(new RenderObject(i.shaderHandle));a[h].material.shader.push(i);i.initRenderProc(a[h],g)}return false}
function createRenderTargetTexture(a,f){var g=gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,g);g.width=a;g.height=f;renderTarget=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,renderTarget);try{gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,g.width,g.height,0,gl.RGBA,gl.UNSIGNED_BYTE,null)}catch(i){var h=new WebGLUnsignedByteArray(g.width*g.height*4);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,g.width,g.height,0,gl.RGBA,gl.UNSIGNED_BYTE,h)}gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);
gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR_MIPMAP_NEAREST);gl.generateMipmap(gl.TEXTURE_2D);h=gl.createRenderbuffer();gl.bindRenderbuffer(gl.RENDERBUFFER,h);gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,g.width,g.height);error=gl.getError(gl.bindFramebuffer(gl.FRAMEBUFFER,g));error=gl.getError(gl.bindRenderbuffer(gl.RENDERBUFFER,h));error=gl.getError(gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,g.width,g.height));gl.bindRenderbuffer(gl.RENDERBUFFER,
null);error=gl.getError(gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,renderTarget,0));error=gl.getError(gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,h));gl.bindFramebuffer(gl.FRAMEBUFFER,null);gl.bindTexture(gl.TEXTURE_2D,null);gl.bindRenderbuffer(gl.RENDERBUFFER,null);gl.bindFramebuffer(gl.FRAMEBUFFER,null);renderTarget.frameBuffer=g;return renderTarget}var uiToIntentMap=[];uiToIntentMap.none=0;uiToIntentMap.body=1;uiToIntentMap.eye=2;
uiToIntentMap.hair=3;uiToIntentMap.shirt=4;uiToIntentMap.pants=5;uiToIntentMap.sticker=6;function mapUIToIntentIndex(a){a=a.split(" ")[0];return uiToIntentMap[a]}function getBaseURL(){var a=location.href;a=a.substring(0,a.indexOf("/",14));if(a.indexOf("http://localhost")!=-1){a=location.href;var f=a.indexOf(location.pathname);f=a.indexOf("/",f+1);return a.substr(0,f)+"/"}else return a+"/"}
function buildModelURL(){return location.href+"?model="+getActiveModel().name+getActiveModel().mesh.createMaterialURL()}
function loadMeshFromURL(){setActiveModel(urlParam("model"));var a=[];a.push({name:null,mat:null,set1:null,set2:null,clr:null,shdr:null});a.push({name:null,mat:null,set1:null,set2:null,clr:null,shdr:null});for(var f=0;f<a.length;f++){a[f].name=urlParam(f+"name");a[f].set1=urlParam(f+"set1");a[f].set2=urlParam(f+"set2");a[f].clr=urlParam(f+"clr");a[f].shdr=urlParam(f+"shdr")}for(var g=getActiveModel().mesh,i=0;i<g.primSets.length;i++){var h=new TextureSet;texSet2=new TextureSet;h=[h,texSet2];f=a[i].set1.split("+");
var k=a[i].set2.split("+");k=[f,k];for(f=0;f<2;f++){h[f].name=k[f][0];h[f].diff=g_texMan.getTextureByName(k[f][1]);h[f].spec=g_texMan.getTextureByName(k[f][2]);h[f].norm=g_texMan.getTextureByName(k[f][3]);h[f].layer=parseInt(k[f][4]);h[f].partName=k[f][5]}g.primSets[i].material.tex.set1.push(h[0]);g.primSets[i].material.tex.set2.push(h[1]);f=a[i].clr.split("+");k=f[0].split(",");h=f[1].split(",");f=f[2].split(",");k=new vec4(parseFloat(k[0])/10,parseFloat(k[1])/10,parseFloat(k[2])/10,parseFloat(k[3])/
10);h=new vec4(parseFloat(h[0])/10,parseFloat(h[1])/10,parseFloat(h[2])/10,parseFloat(h[3])/10);f=new vec4(parseFloat(f[0])/10,parseFloat(f[1])/10,parseFloat(f[2])/10,parseFloat(f[3])/10);g.primSets[i].material.fillColor[0].setvec(k);g.primSets[i].material.fillColor[1].setvec(h);g.primSets[i].material.fillColor[2].setvec(f);g.pushShaderToModel(a[0].shdr)}}function loadStickersFromURL(){var a=urlParam("stickers");setModelCamera(urlParam("model"));g_cam.setstickurl(a)};function inputKB(){}var xMouse=0,yMouse=0;function mouseDown(a){vp=gl.getParameter(gl.VIEWPORT);unProject(a.pageX,vp[3]-a.pageY,0,g_cam.view,gl.perspectiveMatrix,vp);unProject(a.pageX,vp[3]-a.pageY,1,g_cam.view,gl.perspectiveMatrix,vp);xMouse=window.event.clientX;yMouse=window.event.clientY;return false}function mouseUp(){Math.abs(window.event.clientX-xMouse)<5&&Math.abs(window.event.clientY-yMouse)<5&&g_cam.nextSticker();return false}stickerCursor=new vec2(0,0);cursor=new vec2(0,0);
lastMousePos=new vec2(0,0);firstTime=true;
function updateCursorPos(a,f){a=a||window.event;cursor.x=a.x;cursor.y=a.y;if(firstTime){firstTime=false;lastMousePos.x=cursor.x;lastMousePos.y=cursor.y}else{var g=document.documentElement,i=document.body;cursor.x=a.clientX+(g.scrollLeft||i.scrollLeft)-g.clientLeft;cursor.y=a.clientY+(g.scrollTop||i.scrollTop)-g.clientTop;if(!f){lastMousePos.x=cursor.x;lastMousePos.y=cursor.y}}g=document.getElementById("canvas");i=g.width/2;var h=g.height/2;stickerCursor.x=(cursor.x-g.parentNode.offsetLeft-i)/i;stickerCursor.y=
(cursor.y-g.parentNode.offsetTop-h)/h}var stickerZoom=1,zoomDirty=false;function wheel(a){var f=0;if(!a)a=window.event;if(a.wheelDelta){f=a.wheelDelta/120;if(window.opera)f=-f}else if(a.detail)f=-a.detail/3;if(f<0){stickerZoom-=0.5;if(stickerZoom<1)stickerZoom=1;else zoomDirty=true}else if(f>0){stickerZoom+=0.5;zoomDirty=true;if(stickerZoom>4)stickerZoom=4;else zoomDirty=true}a.preventDefault&&a.preventDefault();a.returnValue=false}function getCursorPos(){return cursor}
function getStickerPos(){return stickerCursor}function getStickerZoom(){return stickerZoom};(function(a){a.fn.jcarousel=function(h){if(typeof h=="string"){var k=a(this).data("jcarousel"),j=Array.prototype.slice.call(arguments,1);return k[h].apply(k,j)}else return this.each(function(){a(this).data("jcarousel",new i(this,h))})};var f={vertical:false,rtl:false,start:1,offset:1,size:null,scroll:3,visible:null,animation:"normal",easing:"swing",auto:0,wrap:null,initCallback:null,reloadCallback:null,itemLoadCallback:null,itemFirstInCallback:null,itemFirstOutCallback:null,itemLastInCallback:null,
itemLastOutCallback:null,itemVisibleInCallback:null,itemVisibleOutCallback:null,buttonNextHTML:"<div></div>",buttonPrevHTML:"<div></div>",buttonNextEvent:"click",buttonPrevEvent:"click",buttonNextCallback:null,buttonPrevCallback:null,itemFallbackDimension:null},g=false;a(window).bind("load.jcarousel",function(){g=true});a.jcarousel=function(h,k){this.options=a.extend({},f,k||{});this.locked=false;this.buttonPrev=this.buttonNext=this.list=this.clip=this.container=null;if(!k||k.rtl===undefined)this.options.rtl=
(a(h).attr("dir")||a("html").attr("dir")||"").toLowerCase()=="rtl";this.wh=!this.options.vertical?"width":"height";this.lt=!this.options.vertical?this.options.rtl?"right":"left":"top";for(var j="",o=h.className.split(" "),l=0;l<o.length;l++)if(o[l].indexOf("jcarousel-skin")!=-1){a(h).removeClass(o[l]);j=o[l];break}if(h.nodeName.toUpperCase()=="UL"||h.nodeName.toUpperCase()=="OL"){this.list=a(h);this.container=this.list.parent();if(this.container.hasClass("jcarousel-clip")){if(!this.container.parent().hasClass("jcarousel-container"))this.container=
this.container.wrap("<div></div>");this.container=this.container.parent()}else if(!this.container.hasClass("jcarousel-container"))this.container=this.list.wrap("<div></div>").parent()}else{this.container=a(h);this.list=this.container.find("ul,ol").eq(0)}j!=""&&this.container.parent()[0].className.indexOf("jcarousel-skin")==-1&&this.container.wrap('<div class=" '+j+'"></div>');this.clip=this.list.parent();if(!this.clip.length||!this.clip.hasClass("jcarousel-clip"))this.clip=this.list.wrap("<div></div>").parent();
this.buttonNext=a(".jcarousel-next",this.container);if(this.buttonNext.size()==0&&this.options.buttonNextHTML!=null)this.buttonNext=this.clip.after(this.options.buttonNextHTML).next();this.buttonNext.addClass(this.className("jcarousel-next"));this.buttonPrev=a(".jcarousel-prev",this.container);if(this.buttonPrev.size()==0&&this.options.buttonPrevHTML!=null)this.buttonPrev=this.clip.after(this.options.buttonPrevHTML).next();this.buttonPrev.addClass(this.className("jcarousel-prev"));this.clip.addClass(this.className("jcarousel-clip")).css({overflow:"hidden",
position:"relative"});this.list.addClass(this.className("jcarousel-list")).css({overflow:"hidden",position:"relative",top:0,margin:0,padding:0}).css(this.options.rtl?"right":"left",0);this.container.addClass(this.className("jcarousel-container")).css({position:"relative"});!this.options.vertical&&this.options.rtl&&this.container.addClass("jcarousel-direction-rtl").attr("dir","rtl");var n=this.options.visible!=null?Math.ceil(this.clipping()/this.options.visible):null;j=this.list.children("li");var p=
this;if(j.size()>0){var q=0;l=this.options.offset;j.each(function(){p.format(this,l++);q+=p.dimension(this,n)});this.list.css(this.wh,q+100+"px");if(!k||k.size===undefined)this.options.size=j.size()}this.container.css("display","block");this.buttonNext.css("display","block");this.buttonPrev.css("display","block");this.funcNext=function(){p.next()};this.funcPrev=function(){p.prev()};this.funcResize=function(){p.reload()};this.options.initCallback!=null&&this.options.initCallback(this,"init");if(!g&&
a.browser.safari){this.buttons(false,false);a(window).bind("load.jcarousel",function(){p.setup()})}else this.setup()};var i=a.jcarousel;i.fn=i.prototype={jcarousel:"0.2.5"};i.fn.extend=i.extend=a.extend;i.fn.extend({setup:function(){this.prevLast=this.prevFirst=this.last=this.first=null;this.animating=false;this.tail=this.timer=null;this.inTail=false;if(!this.locked){this.list.css(this.lt,this.pos(this.options.offset)+"px");var h=this.pos(this.options.start);this.prevFirst=this.prevLast=null;this.animate(h,
false);a(window).unbind("resize.jcarousel",this.funcResize).bind("resize.jcarousel",this.funcResize)}},reset:function(){this.list.empty();this.list.css(this.lt,"0px");this.list.css(this.wh,"10px");this.options.initCallback!=null&&this.options.initCallback(this,"reset");this.setup()},reload:function(){this.tail!=null&&this.inTail&&this.list.css(this.lt,i.intval(this.list.css(this.lt))+this.tail);this.tail=null;this.inTail=false;this.options.reloadCallback!=null&&this.options.reloadCallback(this);if(this.options.visible!=
null){var h=this,k=Math.ceil(this.clipping()/this.options.visible),j=0,o=0;this.list.children("li").each(function(l){j+=h.dimension(this,k);if(l+1<h.first)o=j});this.list.css(this.wh,j+"px");this.list.css(this.lt,-o+"px")}this.scroll(this.first,false)},lock:function(){this.locked=true;this.buttons()},unlock:function(){this.locked=false;this.buttons()},size:function(h){if(h!=undefined){this.options.size=h;this.locked||this.buttons()}return this.options.size},has:function(h,k){if(k==undefined||!k)k=
h;if(this.options.size!==null&&k>this.options.size)k=this.options.size;for(var j=h;j<=k;j++){var o=this.get(j);if(!o.length||o.hasClass("jcarousel-item-placeholder"))return false}return true},get:function(h){return a(".jcarousel-item-"+h,this.list)},add:function(h,k){var j=this.get(h),o=0,l=a(k);if(j.length==0){var n;j=this.create(h);for(var p=i.intval(h);n=this.get(--p);)if(p<=0||n.length){p<=0?this.list.prepend(j):n.after(j);break}}else o=this.dimension(j);if(l.get(0).nodeName.toUpperCase()=="LI"){j.replaceWith(l);
j=l}else j.empty().append(k);this.format(j.removeClass(this.className("jcarousel-item-placeholder")),h);l=this.options.visible!=null?Math.ceil(this.clipping()/this.options.visible):null;o=this.dimension(j,l)-o;h>0&&h<this.first&&this.list.css(this.lt,i.intval(this.list.css(this.lt))-o+"px");this.list.css(this.wh,i.intval(this.list.css(this.wh))+o+"px");return j},remove:function(h){var k=this.get(h);if(!(!k.length||h>=this.first&&h<=this.last)){var j=this.dimension(k);h<this.first&&this.list.css(this.lt,
i.intval(this.list.css(this.lt))+j+"px");k.remove();this.list.css(this.wh,i.intval(this.list.css(this.wh))-j+"px")}},next:function(){this.stopAuto();this.tail!=null&&!this.inTail?this.scrollTail(false):this.scroll((this.options.wrap=="both"||this.options.wrap=="last")&&this.options.size!=null&&this.last==this.options.size?1:this.first+this.options.scroll)},prev:function(){this.stopAuto();this.tail!=null&&this.inTail?this.scrollTail(true):this.scroll((this.options.wrap=="both"||this.options.wrap==
"first")&&this.options.size!=null&&this.first==1?this.options.size:this.first-this.options.scroll)},scrollTail:function(h){if(!(this.locked||this.animating||!this.tail)){var k=i.intval(this.list.css(this.lt));!h?k-=this.tail:k+=this.tail;this.inTail=!h;this.prevFirst=this.first;this.prevLast=this.last;this.animate(k)}},scroll:function(h,k){this.locked||this.animating||this.animate(this.pos(h),k)},pos:function(h){var k=i.intval(this.list.css(this.lt));if(this.locked||this.animating)return k;if(this.options.wrap!=
"circular")h=h<1?1:this.options.size&&h>this.options.size?this.options.size:h;for(var j=this.first>h,o=this.options.wrap!="circular"&&this.first<=1?1:this.first,l=j?this.get(o):this.get(this.last),n=j?o:o-1,p=null,q=0,t=false,r=0;j?--n>=h:++n<h;){p=this.get(n);t=!p.length;if(p.length==0){p=this.create(n).addClass(this.className("jcarousel-item-placeholder"));l[j?"before":"after"](p);if(this.first!=null&&this.options.wrap=="circular"&&this.options.size!==null&&(n<=0||n>this.options.size)){l=this.get(this.index(n));
if(l.length)p=this.add(n,l.clone(true))}}l=p;r=this.dimension(p);if(t)q+=r;if(this.first!=null&&(this.options.wrap=="circular"||n>=1&&(this.options.size==null||n<=this.options.size)))k=j?k+r:k-r}o=this.clipping();var u=[],s=0;n=h;var v=0;for(l=this.get(h-1);++s;){p=this.get(n);t=!p.length;if(p.length==0){p=this.create(n).addClass(this.className("jcarousel-item-placeholder"));l.length==0?this.list.prepend(p):l[j?"before":"after"](p);if(this.first!=null&&this.options.wrap=="circular"&&this.options.size!==
null&&(n<=0||n>this.options.size)){l=this.get(this.index(n));if(l.length)p=this.add(n,l.clone(true))}}l=p;r=this.dimension(p);if(r==0)throw Error("jCarousel: No width/height set for items. This will cause an infinite loop. Aborting...");if(this.options.wrap!="circular"&&this.options.size!==null&&n>this.options.size)u.push(p);else if(t)q+=r;v+=r;if(v>=o)break;n++}for(p=0;p<u.length;p++)u[p].remove();if(q>0){this.list.css(this.wh,this.dimension(this.list)+q+"px");if(j){k-=q;this.list.css(this.lt,i.intval(this.list.css(this.lt))-
q+"px")}}q=h+s-1;if(this.options.wrap!="circular"&&this.options.size&&q>this.options.size)q=this.options.size;if(n>q){s=0;n=q;for(v=0;++s;){p=this.get(n--);if(!p.length)break;v+=this.dimension(p);if(v>=o)break}}n=q-s+1;if(this.options.wrap!="circular"&&n<1)n=1;if(this.inTail&&j){k+=this.tail;this.inTail=false}this.tail=null;if(this.options.wrap!="circular"&&q==this.options.size&&q-s+1>=1){j=i.margin(this.get(q),!this.options.vertical?"marginRight":"marginBottom");if(v-j>o)this.tail=v-o-j}for(;h-- >
n;)k+=this.dimension(this.get(h));this.prevFirst=this.first;this.prevLast=this.last;this.first=n;this.last=q;return k},animate:function(h,k){if(!(this.locked||this.animating)){this.animating=true;var j=this,o=function(){j.animating=false;h==0&&j.list.css(j.lt,0);if(j.options.wrap=="circular"||j.options.wrap=="both"||j.options.wrap=="last"||j.options.size==null||j.last<j.options.size)j.startAuto();j.buttons();j.notify("onAfterAnimation");if(j.options.wrap=="circular"&&j.options.size!==null)for(var l=
j.prevFirst;l<=j.prevLast;l++)if(l!==null&&!(l>=j.first&&l<=j.last)&&(l<1||l>j.options.size))j.remove(l)};this.notify("onBeforeAnimation");if(!this.options.animation||k==false){this.list.css(this.lt,h+"px");o()}else this.list.animate(!this.options.vertical?this.options.rtl?{right:h}:{left:h}:{top:h},this.options.animation,this.options.easing,o)}},startAuto:function(h){if(h!=undefined)this.options.auto=h;if(this.options.auto==0)return this.stopAuto();if(this.timer==null){var k=this;this.timer=setTimeout(function(){k.next()},
this.options.auto*1E3)}},stopAuto:function(){if(this.timer!=null){clearTimeout(this.timer);this.timer=null}},buttons:function(h,k){if(h==undefined||h==null){h=!this.locked&&this.options.size!==0&&(this.options.wrap&&this.options.wrap!="first"||this.options.size==null||this.last<this.options.size);if(!this.locked&&(!this.options.wrap||this.options.wrap=="first")&&this.options.size!=null&&this.last>=this.options.size)h=this.tail!=null&&!this.inTail}if(k==undefined||k==null){k=!this.locked&&this.options.size!==
0&&(this.options.wrap&&this.options.wrap!="last"||this.first>1);if(!this.locked&&(!this.options.wrap||this.options.wrap=="last")&&this.options.size!=null&&this.first==1)k=this.tail!=null&&this.inTail}var j=this;this.buttonNext[h?"bind":"unbind"](this.options.buttonNextEvent+".jcarousel",this.funcNext)[h?"removeClass":"addClass"](this.className("jcarousel-next-disabled")).attr("disabled",h?false:true);this.buttonPrev[k?"bind":"unbind"](this.options.buttonPrevEvent+".jcarousel",this.funcPrev)[k?"removeClass":
"addClass"](this.className("jcarousel-prev-disabled")).attr("disabled",k?false:true);this.options.buttonNextCallback!=null&&this.buttonNext.data("jcarouselstate")!=h&&this.buttonNext.each(function(){j.options.buttonNextCallback(j,this,h)}).data("jcarouselstate",h);this.options.buttonPrevCallback!=null&&this.buttonPrev.data("jcarouselstate")!=k&&this.buttonPrev.each(function(){j.options.buttonPrevCallback(j,this,k)}).data("jcarouselstate",k)},notify:function(h){var k=this.prevFirst==null?"init":this.prevFirst<
this.first?"next":"prev";this.callback("itemLoadCallback",h,k);if(this.prevFirst!==this.first){this.callback("itemFirstInCallback",h,k,this.first);this.callback("itemFirstOutCallback",h,k,this.prevFirst)}if(this.prevLast!==this.last){this.callback("itemLastInCallback",h,k,this.last);this.callback("itemLastOutCallback",h,k,this.prevLast)}this.callback("itemVisibleInCallback",h,k,this.first,this.last,this.prevFirst,this.prevLast);this.callback("itemVisibleOutCallback",h,k,this.prevFirst,this.prevLast,
this.first,this.last)},callback:function(h,k,j,o,l,n,p){if(!(this.options[h]==undefined||typeof this.options[h]!="object"&&k!="onAfterAnimation")){var q=typeof this.options[h]=="object"?this.options[h][k]:this.options[h];if(a.isFunction(q)){var t=this;if(o===undefined)q(t,j,k);else if(l===undefined)this.get(o).each(function(){q(t,this,o,j,k)});else for(var r=o;r<=l;r++)r!==null&&!(r>=n&&r<=p)&&this.get(r).each(function(){q(t,this,r,j,k)})}}},create:function(h){return this.format("<li></li>",h)},format:function(h,
k){h=a(h);for(var j=h.get(0).className.split(" "),o=0;o<j.length;o++)j[o].indexOf("jcarousel-")!=-1&&h.removeClass(j[o]);h.addClass(this.className("jcarousel-item")).addClass(this.className("jcarousel-item-"+k)).css({"float":this.options.rtl?"right":"left","list-style":"none"}).attr("jcarouselindex",k);return h},className:function(h){return h+" "+h+(!this.options.vertical?"-horizontal":"-vertical")},dimension:function(h,k){var j=h.jquery!=undefined?h[0]:h,o=!this.options.vertical?(j.offsetWidth||
i.intval(this.options.itemFallbackDimension))+i.margin(j,"marginLeft")+i.margin(j,"marginRight"):(j.offsetHeight||i.intval(this.options.itemFallbackDimension))+i.margin(j,"marginTop")+i.margin(j,"marginBottom");if(k==undefined||o==k)return o;o=!this.options.vertical?k-i.margin(j,"marginLeft")-i.margin(j,"marginRight"):k-i.margin(j,"marginTop")-i.margin(j,"marginBottom");a(j).css(this.wh,o+"px");return this.dimension(j)},clipping:function(){return!this.options.vertical?this.clip[0].offsetWidth-i.intval(this.clip.css("borderLeftWidth"))-
i.intval(this.clip.css("borderRightWidth")):this.clip[0].offsetHeight-i.intval(this.clip.css("borderTopWidth"))-i.intval(this.clip.css("borderBottomWidth"))},index:function(h,k){if(k==undefined)k=this.options.size;return Math.round(((h-1)/k-Math.floor((h-1)/k))*k)+1}});i.extend({defaults:function(h){return a.extend(f,h||{})},margin:function(h,k){if(!h)return 0;var j=h.jquery!=undefined?h[0]:h;if(k=="marginRight"&&a.browser.safari){var o={display:"block","float":"none",width:"auto"},l,n;a.swap(j,o,
function(){l=j.offsetWidth});o.marginRight=0;a.swap(j,o,function(){n=j.offsetWidth});return n-l}return i.intval(a.css(j,k))},intval:function(h){h=parseInt(h);return isNaN(h)?0:h}})})(jQuery);jQuery(document).ready(function(){function a(){jQuery("#loadingMenu").addClass("hide");jQuery("#optionsMenu").addClass("hide");jQuery("#pageContainer").removeClass("dim");k("#tools");jQuery("#tools").removeClass("hide");jQuery("#tools").addClass("slide-enter-left");window.setTimeout(function(){jQuery("#tools").removeClass("hide");jQuery("#tools").addClass("slide-enter-left")},200);window.setTimeout(function(){jQuery("#colorPalette").removeClass("hide");jQuery("#colorPalette").addClass("slide-enter-left");
jQuery("#assets").removeClass("hide");jQuery("#assets").addClass("slide-enter-right")},500);window.setTimeout(function(){jQuery("#decals").addClass("transparent");jQuery("#decals").removeClass("hide");jQuery("#decals").addClass("fall-enter");i("body")},1E3);window.setTimeout(function(){jQuery("#decals li").removeClass("fall-enter");start()},2E3);window.setTimeout(function(){jQuery("#controlArea").addClass("transparent");jQuery("#controlArea").removeClass("hide");jQuery("#controlArea").addClass("canvas-enter")},
2300)}function f(l,n){var p=jQuery(l),q=l.className,t=jQuery("#canvas");g(p.parent());t.removeClass("target pointer move resize");t.addClass(n);if(q!="options")apiUseToolSelected(q);else{jQuery("#tools").addClass("hide");jQuery("#decals").addClass("hide");jQuery("#assets").addClass("hide");jQuery("#colorPalette").addClass("hide");jQuery("#pageContainer").addClass("dim");jQuery("#controlArea").addClass("hide");jQuery("#controlArea").removeClass("show");jQuery("#long-link").val(createModelURL());jQuery("#optionsMenu").removeClass("hide");
jQuery("#optionsMenu").addClass("popupMenu")}}function g(l){l=jQuery(l);l.children().each(function(){jQuery(this).hasClass("selected")&&jQuery(this).removeClass("selected")})}function i(l){var n=jQuery("#"+l+"Assets");l=jQuery("#"+l+"Assets ul");var p=jQuery("#assets");g("#assets");p.children(".jcarousel-skin-patterns").each(function(){jQuery("img").addClass("fade-in")});n.addClass("selected");l.hasClass("jcarousel-list")||l.jcarousel({vertical:true,scroll:4,wrap:"circular"})}function h(l){var n=
jQuery(l);l=l.id;if(!n.hasClass("selected")){g(n.parent());n.addClass("selected");k(l);apiSelectIntent(l);i(l)}}function k(l){jQuery("#decals #sticker");var n=jQuery("#tools .undo"),p=jQuery("#tools .blank");if(l=="sticker"){n.removeClass("hide");p.removeClass("show");n.addClass("show");p.addClass("hide")}else{n.addClass("hide");p.addClass("show");n.removeClass("show");p.removeClass("hide")}}function j(){jQuery("#colorPalette").hasClass("hide")&&jQuery("#colorPalette").removeClass("hide")}document.body.onselectstart=
function(){return false};jQuery("#loadingMenu img").click(function(){setActiveModel(this.id);a()});preload();var o=true;if(urlParam("model"))o=false;if(o){jQuery("#pageContainer").addClass("dim");jQuery("#loadingMenu").removeClass("hide")}else a();jQuery("#tools").draggable({handle:"h3",containment:"#pageContainer"});jQuery("#colorPalette").draggable({handle:"h3",containment:"#pageContainer"});jQuery("li.stamp").click(function(){f(this,"target")});jQuery("li.move").click(function(){f(this,"move")});
jQuery("li.shader").click(function(){f(this,"target")});jQuery("li.undo").click(function(){f(this,"pointer")});jQuery("li.fill").click(function(){f(this,"target")});jQuery("li.zoom").click(function(){f(this,"move")});jQuery("li.options").click(function(){f(this,"pointer")});jQuery("li.doll1").click(function(){f(this,"pickMale")});jQuery("li.doll2").click(function(){f(this,"pickFemale")});jQuery("li.cameraReset").click(function(){f(this,"reset")});jQuery("li#body").click(function(){h(this);j()});jQuery("li#eye").click(function(){h(this);
j()});jQuery("li#hair").click(function(){h(this);j()});jQuery("li#shirt").click(function(){h(this);j()});jQuery("li#pants").click(function(){h(this);j()});jQuery("li#sticker").click(function(){h(this);jQuery("#colorPalette").addClass("fade-out");jQuery("#colorPalette").addClass("hide")});jQuery("#assets ul li").click(function(){var l=jQuery(this),n=this.id;g(l.parent());l.addClass("selected");apiPushMaterial(n)});jQuery("#optionsMenu #restart").click(function(){location.reload(true)});jQuery("#optionsMenu a").click(function(){apiSetGraphicsQuality(this.id);
a();jQuery("#controlArea").removeClass("hide");jQuery("#controlArea").addClass("show")});jQuery("#optionsMenu #close").click(function(){jQuery("#controlArea").removeClass("hide");a()})});function _$(a,f){return(typeof f=="object"?f:document).getElementById(a)}function _$S(a){if(a=_$(a))return a.style}function abPos(a){a=typeof a=="object"?a:_$(a);for(var f={X:0,Y:0};a!=null;){f.X+=a.offsetLeft;f.Y+=a.offsetTop;a=a.offsetParent}return f}function agent(a){return Math.max(navigator.userAgent.toLowerCase().indexOf(a),0)}function isset(a){return typeof a=="undefined"||a.length==0?false:true}
function toggle(a,f,g){a=_$S(a);a.display=f?f:a.display=="none"?"block":"none";if(g){a.left=g[0];a.top=g[1]}}function XY(a,f){var g=agent("msie")?{X:a.clientX+document.body.scrollLeft,Y:a.clientY+document.body.scrollTop}:{X:a.pageX,Y:a.pageY};return f?g[f]:g}function zero(a){return!isNaN(a=parseFloat(a))?a:0}function zindex(a){a.style.zIndex=zINDEX++}Picker={};Picker.stop=1;
Picker.core=function(a,f,g,i,h){function k(q,t,r){o=XY(r);var u=[o.X+q,o.Y+t];h&&h(u);if(a=="mCur"){q=parseInt(_$S("mSpec").width);t=q/2;r=t/2;var s=u[0]-t-3,v=q-u[1]-t+21+10;u=Math.sqrt(Math.pow(s,2)+Math.pow(v,2));s=Math.atan2(s,v)/(Math.PI*2);hsv={H:s>0?s*360:s*360+360,S:u<r?u/r*100:100,V:u>=r?Math.max(0,1-(u-r)/(t-r))*100:100};color.cords(q);apiSetColor(color.HSV_RGB(hsv));jQuery("div.north").css("background-color","#"+color.HSV_HEX(hsv))}else if(a=="mSize"){q=Math.max(Math.max(u[0],u[1])+l,75);
color.cords(q);_$S("mini").height=q+28+"px";_$S("mini").width=q+20+"px";_$S("mSpec").height=q+"px";_$S("mSpec").width=q+"px"}else{if(g)u=[Math.max(!isNaN(g[2])?g[2]:0,!isNaN(g[0])?Math.min(g[0],u[0]):u[0]),Math.max(!isNaN(g[3])?g[3]:0,!isNaN(g[1])?Math.min(g[1],u[1]):u[1])];if(!g||g[0])j.left=u[0]+"px";if(!g||g[1])j.top=u[1]+"px"}}if(Picker.stop){Picker.stop="";var j=_$S(a),o=XY(f);i||zindex(_$(a));if(a=="mCur"){i=abPos(_$(a).parentNode);k(-(i.X-5),-(i.Y-28),f)}if(a=="mSize")var l=parseInt(_$S("mSpec").height),
n=-XY(f).X,p=-XY(f).Y;else{n=zero(j.left)-o.X;p=zero(j.top)-o.Y}document.onmousemove=function(q){Picker.stop||k(n,p,q)};document.onmouseup=function(){Picker.stop=1;document.onmousemove="";document.onmouseup=""}}};Picker.hsv={H:0,S:0,V:100};zINDEX=2;color={};color.cords=function(a){a=a/2;var f=hsv.H/360*Math.PI*2,g=(hsv.S+(100-hsv.V))/100*(a/2);_$S("mCur").left=Math.round(Math.abs(Math.round(Math.sin(f)*g)+a+3))+"px";_$S("mCur").top=Math.round(Math.abs(Math.round(Math.cos(f)*g)-a-21))+"px"};
color.HEX=function(a){a=Math.round(Math.min(Math.max(0,a),255));return"0123456789ABCDEF".charAt((a-a%16)/16)+"0123456789ABCDEF".charAt(a%16)};color.RGB_HEX=function(a){var f=color.HEX;return f(a.R)+f(a.G)+f(a.B)};
color.HSV_RGB=function(a){var f,g,i,h;h=a.S/100;var k=a.V/100,j=a.H/360;if(h>0){if(j>=1)j=0;j=6*j;F=j-Math.floor(j);a=Math.round(255*k*(1-h));i=Math.round(255*k*(1-h*F));h=Math.round(255*k*(1-h*(1-F)));k=Math.round(255*k);switch(Math.floor(j)){case 0:f=k;g=h;i=a;break;case 1:f=i;g=k;i=a;break;case 2:f=a;g=k;i=h;break;case 3:f=a;g=i;i=k;break;case 4:f=h;g=a;i=k;break;case 5:f=k;g=a;break}return{R:f?f:0,G:g?g:0,B:i?i:0,A:255}}else return{R:k=Math.round(k*255),G:k,B:k,A:255}};color.HSV_HEX=function(a){return color.RGB_HEX(color.HSV_RGB(a))};g_cam=new camera;g_width=document.getElementById("canvas").width;g_height=document.getElementById("canvas").height;g_camMoveSpeed=25;gl=null;g_worldObjects=[];g_collMan=new CollisionManager;g_meshMan=new MeshManager;g_texMan=new TextureManager;g_shaderMan=new ShaderManager;g_mouseDown=false;g_alphaTex=g_defaultTex=null;g_hiQu=true;g_IntentSelected=1;g_IntentText=["None","Skin","Face","Hair","Body","Legs","Stickers"];function tick(){draw(gl);mouse=new vec2(0,0);mouse=getCursorPos()}
function preload(){gl=preinit()}function start(){document.onkeydown=inputKB;element=document.getElementById("pageContainer");element.onmousemove=function(a){updateCursorPos(a,g_mouseDown)};element.onmouseup=function(a){g_mouseDown=false;return mouseUp(a)};init();framerate=new Framerate("fps");setInterval("tick()",25)};function urlParam(a){a=RegExp("[\\?&]"+a+"=([^&#]*)").exec(window.location.href);if(!a)return 0;return a[1]||0}function shortenURL(a){var f={version:"2.0.1",login:"humanengines",apiKey:"R_909ee310e09db4e8837a3109b81bf984",history:"0",longUrl:a};jQuery.getJSON("http://api.bit.ly/shorten?version="+f.version+"&longUrl="+f.longUrl+"&login="+f.login+"&apiKey="+f.apiKey+"&history="+f.history+"&format=json&callback=?",function(g){set_short_url_val(g.results[f.longUrl].shortUrl)})}
function set_url_vals(){var a=jQuery("#long-link").val();shortenURL(a)}function set_short_url_val(a){jQuery("#bitly").val(a)};
